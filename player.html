<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Zatur RPG - Player Mobile V2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&family=Lora:ital,wght@0,400;1,500&display=swap');

        :root {
            --gold: #d4af37; --gold-bright: #ffdf00; --parchment: #f4e4bc;
            --bg-dark: #0a0502; --panel-bg: rgba(30, 20, 10, 0.95);
            --red: #8b0000; --blue: #1e4d8c; --purple: #6a0dad; --skill: #3498db;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; font-family: 'Lora', serif; 
            background: var(--bg-dark); color: var(--parchment); 
            padding-bottom: 80px; overscroll-behavior-y: none;
        }

        /* --- HEADER --- */
        header {
            background: linear-gradient(to bottom, #2c1a0a, #120b04);
            padding: 10px; text-align: center; border-bottom: 2px solid var(--gold);
            position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        header h1 { font-family: 'Cinzel', serif; margin: 0; color: var(--gold); font-size: 1.2rem; }
        .currency-bar { 
            font-family:'MedievalSharp'; color:var(--gold-bright); margin-top:5px; font-size: 0.9rem; 
            display: flex; justify-content: center; gap: 15px; 
        }

        /* --- TABS --- */
        nav.tabs { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: #1a0f06; border-top: 2px solid var(--gold);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; box-shadow: 0 -4px 15px rgba(0,0,0,0.5);
        }
        nav.tabs button { 
            background: none; border: none; color: #666; 
            font-family: 'Cinzel'; font-size: 0.65rem; font-weight: bold;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; transition: 0.2s; width: 100%; height: 100%; justify-content: center;
        }
        nav.tabs button span.icon { font-size: 1.3rem; display: block; margin-bottom: 2px; }
        nav.tabs button.active { color: var(--gold-bright); background: rgba(255, 215, 0, 0.05); }

        /* --- CONTENT --- */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; animation: fadeIn 0.3s ease; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { 
            background: var(--panel-bg); border: 1px solid #4b2e0e; 
            padding: 15px; border-radius: 8px; margin-bottom: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
        }

        /* --- BARRAS --- */
        .status-wrapper { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .status-row { display: flex; align-items: center; gap: 10px; }
        .status-icon { font-size: 1.2rem; width: 25px; text-align: center; }
        .status-bar-container { flex-grow: 1; height: 18px; background: #000; border: 1px solid #555; border-radius: 4px; position: relative; }
        .bar-fill { height: 100%; transition: width 0.4s ease-out; }
        .bar-text { position: absolute; width: 100%; top: -1px; text-align: center; font-size: 0.75rem; font-family: 'MedievalSharp'; text-shadow: 1px 1px 1px black; color: white; }

        /* --- ATRIBUTOS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .stat-box { 
            background: #251608; border: 1px solid #3d2612; padding: 8px 5px; text-align: center; 
            border-radius: 6px; cursor: pointer; position: relative; overflow: hidden;
        }
        .stat-box:active { background: #5a3a1a; transform: scale(0.98); }
        .stat-box label { font-size: 0.6rem; color: #aaa; display: block; letter-spacing: 1px; }
        .stat-box span { font-size: 1.4rem; font-family: 'MedievalSharp'; color: var(--parchment); }
        
        /* --- PER√çCIAS --- */
        .pericia-tag {
            display: inline-flex; align-items: center; justify-content: space-between;
            background: #112233; color: var(--skill); border: 1px solid #1e4d8c;
            padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; margin: 4px;
            cursor: pointer; transition: 0.2s;
        }
        .pericia-tag:active { background: var(--skill); color: #fff; }
        .pericia-val { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px; font-weight: bold; }

        /* --- LISTAS --- */
        .list-item { 
            background: rgba(0,0,0,0.3); padding: 12px; border-bottom: 1px solid #333; margin-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center; border-radius: 4px;
        }
        .list-item:active { background: rgba(212,175,55,0.1); }
        .list-info h4 { margin: 0; font-size: 0.95rem; color: var(--gold); }
        .list-info small { color: #999; font-size: 0.75rem; display: block; }
        .roll-btn { 
            background: #222; border: 1px solid #555; color: #ddd; width: 40px; height: 40px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            cursor: pointer; margin-left: 10px;
        }
        .roll-btn:active { background: var(--gold); color: black; }

        /* --- INVENTARIO GRID --- */
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .inv-slot { 
            background: #251608; border: 1px solid #3d2612; aspect-ratio: 1/1; 
            border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; padding: 5px;
        }
        .inv-slot img { width: 100%; height: 70%; object-fit: contain; }
        .inv-slot span { font-size: 0.6rem; margin-top: 3px; text-align: center; white-space: nowrap; overflow: hidden; width: 100%; text-overflow: ellipsis; }

        /* --- MAPA --- */
        #map-container { 
            width: 100%; height: 70vh; background: #000; border: 2px solid var(--gold); 
            position: relative; overflow: hidden; border-radius: 4px; touch-action: none;
        }
        #mapCanvas { width: 100%; height: 100%; display: block; }
        .zoom-controls { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
        .zoom-btn { width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.7); border: 2px solid var(--gold); color: white; font-size: 1.5rem; }

        /* --- MODAL DE DADOS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { 
            background: #f4e4bc; color: #1a0f06; padding: 20px; border-radius: 8px; width: 85%; max-width: 320px; 
            text-align: center; border: 4px double #1a0f06; box-shadow: 0 0 30px black; animation: fadeIn 0.2s;
        }
        .dice-result { font-size: 4rem; font-family: 'MedievalSharp'; font-weight: bold; margin: 10px 0; display: block; }
        .dice-formula { font-size: 0.8rem; color: #555; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 4px; display: inline-block; margin-bottom: 10px;}
        .dice-crit { color: #8b0000; text-shadow: 0 0 10px rgba(139,0,0,0.5); }
        .dice-fail { color: #444; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div style="font-size:0.7rem; color:#888; text-transform:uppercase;" id="player-name-display">...</div>
    <h1 id="header-name">Zatur RPG</h1>
    <div class="currency-bar">
        <span>üí∞ <span id="zeuro-val">0</span></span>
        <span>‚ú® <span id="xp-val">0</span></span>
    </div>
</header>

<main class="container">
    
    <section id="tab-ficha" class="tab-content active">
        <div class="card">
            <div class="status-wrapper">
                <div class="status-row">
                    <span class="status-icon">‚ù§Ô∏è</span>
                    <div class="status-bar-container">
                        <div id="bar-pv" class="bar-fill" style="background:var(--red); width: 0%"></div>
                        <div class="bar-text" id="txt-pv">0/0</div>
                    </div>
                </div>
                <div class="status-row">
                    <span class="status-icon">üíß</span>
                    <div class="status-bar-container">
                        <div id="bar-pe" class="bar-fill" style="background:var(--blue); width: 0%"></div>
                        <div class="bar-text" id="txt-pe">0/0</div>
                    </div>
                </div>
            </div>

            <h3 style="margin:5px 0; font-size:0.8rem; color:#666; font-family:'Cinzel'">Atributos (1d20)</h3>
            <div class="stats-grid" id="stats-area"></div>
            
            <div style="display:flex; justify-content:space-between; margin-top:10px; background:rgba(0,0,0,0.2); padding:5px; border-radius:4px;">
                <div style="text-align:center;"><small style="color:#888">DEFESA</small><br><strong style="color:white" id="val-def">0</strong></div>
                <div style="text-align:center;"><small style="color:#888">DESL</small><br><strong style="color:white" id="val-desl">0m</strong></div>
            </div>
        </div>

        <div class="card" id="pericias-card" style="display:none;">
            <h3 style="margin:0 0 10px 0; color:var(--skill); font-family:Cinzel;">Per√≠cias & Treinos</h3>
            <div id="pericias-list" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
        </div>

        <div class="card">
            <h3 style="margin:0 0 5px 0; font-family:Cinzel; color:#888; font-size:0.9rem;">Biografia</h3>
            <p id="char-bio" style="font-size:0.8rem; color:#aaa; font-style:italic; margin:0;"></p>
        </div>
    </section>

    <section id="tab-combat" class="tab-content">
        <div class="card">
            <h2 style="color:var(--gold); font-family:Cinzel; font-size:1.1rem; border-bottom:1px solid #333; padding-bottom:5px;">‚öîÔ∏è Habilidades</h2>
            <div id="hab-list"></div>
        </div>
        
        <div class="card" style="border-color: var(--purple);">
            <h2 style="color:#b19cd9; font-family:Cinzel; font-size:1.1rem; border-bottom:1px solid #4a235a; padding-bottom:5px;">üîÆ Grim√≥rio</h2>
            <div id="spell-list"></div>
        </div>
    </section>

    <section id="tab-inv" class="tab-content">
        <div class="card">
            <h2 style="color:var(--gold); font-family:Cinzel; font-size:1.2rem;">üéí Mochila</h2>
            <div class="inv-grid" id="inv-list"></div>
        </div>
    </section>

    <section id="tab-shop" class="tab-content">
        <div class="card">
            <h2 style="color:var(--gold); font-family:Cinzel; font-size:1.2rem;">üèõÔ∏è Mercado</h2>
            <div id="shop-container">
                <div class="inv-grid" id="shop-list"></div>
            </div>
            <div id="shop-locked" style="text-align:center; padding:30px; display:none;">
                <i class="fas fa-lock" style="font-size:2rem; color:#555; margin-bottom:10px;"></i><br>LOJA FECHADA
            </div>
        </div>
    </section>

    <section id="tab-map" class="tab-content">
        <div id="map-container">
            <canvas id="mapCanvas"></canvas>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="adjustZoom(0.1)">+</button>
                <button class="zoom-btn" onclick="adjustZoom(-0.1)">-</button>
            </div>
        </div>
        <p style="text-align:center; font-size:0.75rem; color:#666; margin-top:5px;">Toque e arraste para mover seu token.</p>
    </section>

</main>

<nav class="tabs">
    <button class="tab-btn active" data-tab="tab-ficha">
        <span class="icon"><i class="fas fa-user-circle"></i></span> Ficha
    </button>
    <button class="tab-btn" data-tab="tab-combat">
        <span class="icon"><i class="fas fa-hand-sparkles"></i></span> Poderes
    </button>
    <button class="tab-btn" data-tab="tab-inv">
        <span class="icon"><i class="fas fa-hiking"></i></span> Itens
    </button>
    <button class="tab-btn" data-tab="tab-shop">
        <span class="icon"><i class="fas fa-store"></i></span> Loja
    </button>
    <button class="tab-btn" data-tab="tab-map">
        <span class="icon"><i class="fas fa-map-marked-alt"></i></span> Mapa
    </button>
</nav>

<div id="modal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="m-title" style="margin-top:0; font-family:Cinzel; color:#1a0f06;">Resultado</h3>
        <div id="m-result-area"></div>
        <button onclick="document.getElementById('modal').style.display='none'" style="margin-top:15px; background:#1a0f06; color:var(--gold); border:none; padding:10px 25px; border-radius:4px; font-weight:bold;">FECHAR</button>
    </div>
</div>

<div id="music-alert" onclick="activateAudio()" style="position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:var(--gold); color:black; padding:8px 20px; border-radius:20px; font-size:0.8rem; font-weight:bold; z-index:90; display:none; box-shadow:0 0 15px var(--gold);">üéµ TOCAR M√öSICA</div>
<audio id="bg-audio" loop></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, getDoc, updateDoc, collection, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgYVod9B99WIc_QysFx73htOf9O8XtuE8",
        authDomain: "zatur-rpg.firebaseapp.com",
        projectId: "zatur-rpg",
        storageBucket: "zatur-rpg.firebasestorage.app",
        messagingSenderId: "797058283992",
        appId: "1:797058283992:web:7132e71691a225c1255aad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const charId = new URLSearchParams(window.location.search).get("id");
    const audio = document.getElementById('bg-audio');
    
    let charData = {};
    let spellsCache = {}; // Cache global de magias para pegar o Dano
    let itemsCache = {}; // Cache de itens

    // --- CARREGAMENTO INICIAL ---
    async function init() {
        // Carrega magias para cache (para saber o dado de dano)
        const sQuery = await getDocs(collection(db, "spells"));
        sQuery.forEach(doc => spellsCache[doc.data().Nome] = doc.data());
        
        // Carrega Itens para cache
        const iQuery = await getDocs(collection(db, "items"));
        iQuery.forEach(doc => itemsCache[doc.id] = doc.data());

        if (charId) {
            onSnapshot(doc(db, "characters", charId), (snap) => {
                if (!snap.exists()) return;
                charData = snap.data();
                renderCharacter(charData);
            });
        }
    }
    init();

    // --- RENDERIZA√á√ÉO ---
    function renderCharacter(d) {
        document.getElementById('header-name').innerText = d.Nome;
        document.getElementById('player-name-display').innerText = d.PlayerName || "Aventureiro";
        document.getElementById('zeuro-val').innerText = d.Zeuro || 0;
        document.getElementById('xp-val').innerText = d.XP || 0;
        document.getElementById('char-bio').innerText = d.Historia || "Sem biografia.";
        
        // Barras
        updateBar('pv', d.PV, d.PV_Max);
        updateBar('pe', d.PE, d.PE_Max);

        // Stats Secund√°rios
        document.getElementById('val-def').innerText = d.Defesa_Total || 0;
        document.getElementById('val-desl').innerText = d.Deslocamento || "9m";

        // Atributos
        const stats = ["For√ßa", "Agilidade", "Intelecto", "Vigor", "Mana"];
        document.getElementById('stats-area').innerHTML = stats.map(s => {
            const val = d[s] || 0;
            return `
            <div class="stat-box" onclick="window.rolar('${s}', null, ${val})">
                <label>${s.substring(0,3).toUpperCase()}</label>
                <span>${val}</span>
                <i class="fas fa-dice-d20" style="position:absolute; bottom:5px; right:5px; font-size:0.6rem; color:#555;"></i>
            </div>`;
        }).join('');

        // Per√≠cias (Sincronizado com o novo formato de string "Nome (+5)")
        const pList = d.pericias || [];
        const pDiv = document.getElementById('pericias-list');
        const pCard = document.getElementById('pericias-card');
        
        if(pList.length > 0) {
            pCard.style.display = 'block';
            pDiv.innerHTML = "";
            pList.forEach(pStr => {
                // Parse string: "Furtividade (+5)" ou "Luta (+2)"
                const match = pStr.match(/(.+)\s\(([\+\-]?\d+)\)/);
                let nome = pStr; 
                let bonus = 0;
                
                if(match) {
                    nome = match[1];
                    bonus = parseInt(match[2]);
                }

                const el = document.createElement('div');
                el.className = 'pericia-tag';
                el.innerHTML = `${nome} <span class="pericia-val">${bonus>=0?'+':''}${bonus}</span>`;
                el.onclick = () => window.rolar(nome, null, bonus); // Rola 1d20 + Bonus
                pDiv.appendChild(el);
            });
        } else {
            pCard.style.display = 'none';
        }

        // Listas
        renderHabilidades(d.habilidades || []);
        renderInventory(d.itens || []);
    }

    // --- RENDERIZADORES ESPEC√çFICOS ---
    function renderHabilidades(list) {
        // Habilidades e Magias agora podem estar misturadas ou separadas
        // O Desktop salvava em 'habilidades'. Vamos verificar se √© magia pelo cache.
        const habDiv = document.getElementById('hab-list');
        const spellDiv = document.getElementById('spell-list');
        habDiv.innerHTML = ""; spellDiv.innerHTML = "";

        if(list.length === 0) {
            habDiv.innerHTML = "<small style='display:block; text-align:center; color:#555'>Vazio</small>";
            spellDiv.innerHTML = "<small style='display:block; text-align:center; color:#555'>Vazio</small>";
            return;
        }

        list.forEach(itemStr => {
            // Verifica se √© uma Magia conhecida (est√° no cache de spells)
            if(spellsCache[itemStr]) {
                const s = spellsCache[itemStr];
                const dano = s.Dano || ""; // Ex: "2d6"
                const desc = `Custo: ${s.Custo || 0} PE | ${s.Descricao?.substring(0,40)}...`;
                
                const div = document.createElement('div');
                div.className = "list-item";
                div.innerHTML = `
                    <div class="list-info" style="flex:1">
                        <h4>${itemStr}</h4>
                        <small style="color:#b19cd9">${dano ? 'Dano: '+dano : 'Efeito'} | ${desc}</small>
                    </div>
                    <div class="roll-btn" onclick="window.rolar('${itemStr}', '${dano}', 0)">
                        <i class="fas fa-dice"></i>
                    </div>
                `;
                spellDiv.appendChild(div);
            } else {
                // √â uma habilidade manual ou item n√£o m√°gico
                const div = document.createElement('div');
                div.className = "list-item";
                div.innerHTML = `
                    <div class="list-info">
                        <h4>${itemStr}</h4>
                        <small>Habilidade</small>
                    </div>
                    <div class="roll-btn" onclick="window.rolar('${itemStr}', null, 0)">
                        <i class="fas fa-dice-d20"></i>
                    </div>
                `;
                habDiv.appendChild(div);
            }
        });
    }

    function renderInventory(ids) {
        const area = document.getElementById('inv-list');
        area.innerHTML = "";
        ids.forEach(itemId => {
            const item = itemsCache[itemId] || { Nome: itemId, Imagem: null, Dano: null };
            
            const el = document.createElement('div');
            el.className = 'inv-slot';
            // Se tiver dano (arma), ao clicar rola o dano. Se n√£o, mostra descri√ß√£o.
            if(item.Dano) {
                el.onclick = () => window.rolar(item.Nome, item.Dano, 0); // Ex: Rolar Espada 1d8
            } else {
                el.onclick = () => alert(`${item.Nome}\n\n${item.Descricao || "Sem descri√ß√£o."}`);
            }

            el.innerHTML = `
                <img src="${item.Imagem || 'https://cdn-icons-png.flaticon.com/512/1251/1251784.png'}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1251/1251784.png'">
                <span>${item.Nome}</span>
                ${item.Dano ? '<i class="fas fa-dice" style="position:absolute; top:2px; right:2px; font-size:0.6rem; color:var(--gold)"></i>' : ''}
            `;
            area.appendChild(el);
        });
    }

    // --- SISTEMA DE ROLAGEM AVAN√áADO ---
    window.rolar = (nome, dadoStr, bonus = 0) => {
        const modal = document.getElementById('modal');
        const title = document.getElementById('m-title');
        const area = document.getElementById('m-result-area');
        
        title.innerText = nome;
        modal.style.display = 'flex';

        let total = 0;
        let formulaText = "";
        let resultHtml = "";
        let isCrit = false;
        let isFail = false;

        // 1. Se N√ÉO tiver string de dado (null ou vazio), rola 1d20 (Padr√£o Atributos/Per√≠cias)
        if(!dadoStr) {
            const d20 = Math.floor(Math.random() * 20) + 1;
            total = d20 + bonus;
            formulaText = `1d20 (${d20}) + ${bonus}`;
            
            if(d20 === 20) { isCrit = true; resultHtml = "SUCESSO CR√çTICO!"; }
            else if(d20 === 1) { isFail = true; resultHtml = "FALHA CR√çTICA!"; }
            else { resultHtml = "Normal"; }

            area.innerHTML = `
                <span class="dice-formula">${formulaText}</span>
                <span class="dice-result ${isCrit?'dice-crit':''} ${isFail?'dice-fail':''}">${total}</span>
                <div style="font-weight:bold; color:#555;">${resultHtml}</div>
            `;
        } 
        // 2. Se tiver string de dado (Ex: "2d6", "1d8+2")
        else {
            // Regex simples para XdY
            const match = dadoStr.toLowerCase().match(/(\d+)d(\d+)/);
            if(match) {
                const qtd = parseInt(match[1]);
                const faces = parseInt(match[2]);
                let somaDados = 0;
                let detalhes = [];

                for(let i=0; i<qtd; i++) {
                    const r = Math.floor(Math.random() * faces) + 1;
                    somaDados += r;
                    detalhes.push(r);
                }
                
                total = somaDados + bonus; // O bonus aqui vem do parametro, mas as vezes o bonus ta na string do item. Simplificando.
                formulaText = `${dadoStr} [${detalhes.join('+')}] ${bonus!=0 ? '+ '+bonus : ''}`;
                
                area.innerHTML = `
                    <span class="dice-formula">${formulaText}</span>
                    <span class="dice-result" style="color:var(--gold)">${total}</span>
                    <div style="font-size:0.8rem; color:#888;">Dano / Efeito</div>
                `;
            } else {
                // Fallback se a string for inv√°lida (ex: "Especial")
                area.innerHTML = `<p>${dadoStr}</p>`;
            }
        }
    };

    function updateBar(type, current, max) {
        if(!max) max = 1;
        const pct = Math.min(100, Math.max(0, (current / max) * 100));
        document.getElementById(`bar-${type}`).style.width = `${pct}%`;
        document.getElementById(`txt-${type}`).innerText = `${current}/${max}`;
    }

    // --- LOJA & GLOBAL SETTINGS ---
    onSnapshot(doc(db, "campaign_settings", "global"), (snap) => {
        if (!snap.exists()) return;
        const g = snap.data();
        
        // Musica
        if (g.musica_url && audio.src !== g.musica_url) {
            audio.src = g.musica_url;
            document.getElementById('music-alert').style.display = 'block';
        }
        
        // Mapa
        if (g.mapa_url && mapImg.src !== g.mapa_url) {
            mapImg.src = g.mapa_url;
            mapImg.onload = () => { canvas.width = mapImg.width; canvas.height = mapImg.height; renderMap(); };
        }
        tokens = g.posicoes || {};
        renderMap();

        // Loja
        const shopDiv = document.getElementById('shop-container');
        const shopLock = document.getElementById('shop-locked');
        if(g.loja_aberta) {
            shopDiv.style.display = 'block'; shopLock.style.display = 'none'; renderShop();
        } else {
            shopDiv.style.display = 'none'; shopLock.style.display = 'block';
        }
    });

    async function renderShop() {
        const area = document.getElementById('shop-list');
        if(area.innerHTML !== "") return;
        const q = await getDocs(collection(db, "items"));
        area.innerHTML = "";
        q.forEach(s => {
            const i = s.data();
            if(i.Preco) {
                const el = document.createElement('div');
                el.className = 'inv-slot';
                el.innerHTML = `
                    <img src="${i.Imagem || 'https://cdn-icons-png.flaticon.com/512/1251/1251784.png'}">
                    <span>${i.Nome}</span>
                    <span style="color:var(--gold-bright); font-weight:bold;">$${i.Preco}</span>
                `;
                el.onclick = () => comprarItem(s.id, i.Nome, i.Preco);
                area.appendChild(el);
            }
        });
    }

    async function comprarItem(id, nome, preco) {
        if((charData.Zeuro || 0) < preco) return alert("Dinheiro insuficiente!");
        if(confirm(`Comprar ${nome} por $${preco}?`)) {
            await updateDoc(doc(db, "characters", charId), {
                Zeuro: (charData.Zeuro || 0) - preco,
                itens: arrayUnion(id)
            });
            alert("Compra realizada!");
        }
    }

    // --- MAPA ENGINE ---
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    let mapImg = new Image();
    let tokens = {};
    let zoom = 1.0;
    let isDragging = false;

    function renderMap() {
        if (!mapImg.src) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(mapImg, 0, 0, canvas.width * zoom, canvas.height * zoom);
        
        for (let id in tokens) {
            const t = tokens[id];
            ctx.beginPath();
            ctx.arc(t.x * zoom, t.y * zoom, 20 * zoom, 0, Math.PI * 2);
            ctx.fillStyle = (id === charId) ? "rgba(255,215,0,0.8)" : "rgba(139,0,0,0.6)";
            ctx.fill();
            ctx.lineWidth = 3; ctx.strokeStyle = "white"; ctx.stroke();
            
            // Desenha nome
            ctx.fillStyle = "white"; ctx.font = `${12*zoom}px Arial`; ctx.textAlign = "center";
            ctx.fillText(t.nome || "?", t.x * zoom, (t.y * zoom) - (25*zoom));
        }
    }

    function getEventPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: (clientX - rect.left) / (rect.width / canvas.width) / zoom,
            y: (clientY - rect.top) / (rect.height / canvas.height) / zoom
        };
    }

    function startDrag(e) {
        const pos = getEventPos(e);
        if (tokens[charId]) {
            const dist = Math.sqrt((pos.x - tokens[charId].x)**2 + (pos.y - tokens[charId].y)**2);
            if (dist < 40) isDragging = true;
        }
    }
    function moveDrag(e) {
        if (isDragging) {
            e.preventDefault();
            const pos = getEventPos(e);
            tokens[charId].x = pos.x; tokens[charId].y = pos.y;
            renderMap();
        }
    }
    async function endDrag() {
        if (isDragging) {
            await updateDoc(doc(db, "campaign_settings", "global"), { [`posicoes.${charId}`]: tokens[charId] });
        }
        isDragging = false;
    }

    canvas.addEventListener('mousedown', startDrag); canvas.addEventListener('mousemove', moveDrag); canvas.addEventListener('mouseup', endDrag);
    canvas.addEventListener('touchstart', startDrag, {passive: false}); canvas.addEventListener('touchmove', moveDrag, {passive: false}); canvas.addEventListener('touchend', endDrag);

    window.adjustZoom = (val) => { zoom += val; if(zoom < 0.2) zoom = 0.2; renderMap(); };
    window.activateAudio = () => { audio.play(); document.getElementById('music-alert').style.display = 'none'; };

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.onclick = () => {
            document.querySelectorAll('.tab-btn, .tab-content').forEach(e => e.classList.remove('active'));
            b.classList.add('active');
            document.getElementById(b.dataset.tab).classList.add('active');
            if(b.dataset.tab === 'tab-map') setTimeout(renderMap, 100);
        };
    });
</script>
</body>
</html>
