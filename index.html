<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zatur - Painel Supremo (Mestre) vFinal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto+Mono:wght@400;500&family=MedievalSharp&display=swap');
        
        :root {
            --bg-dark: #0a0a0a;
            --sidebar: #121212;
            --card-bg: #1c1c1c;
            --gold: #d4af37;
            --gold-dim: #8f782b;
            --magic: #9b59b6;
            --magic-dim: #5e3370;
            --skill: #3498db;
            --danger: #9e2a2b;
            --success: #386641;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border: #333;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'MedievalSharp', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: grid;
            grid-template-columns: 260px 1fr;
            overflow: hidden;
        }

        /* === SIDEBAR === */
        aside {
            background-color: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 20px;
            box-shadow: 4px 0 15px rgba(0,0,0,0.5);
        }

        .brand {
            font-family: 'Cinzel', serif; font-size: 1.8rem; color: var(--gold);
            text-align: center; margin-bottom: 30px; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            border-bottom: 2px solid var(--gold-dim); padding-bottom: 10px;
        }

        nav button {
            background: transparent; border: none; width: 100%;
            text-align: left; padding: 12px 15px; margin-bottom: 5px;
            color: var(--text-muted); font-family: 'Cinzel', serif; font-size: 1rem;
            cursor: pointer; border-radius: 6px; transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        nav button:hover { background: rgba(255,255,255,0.05); color: var(--gold); }
        nav button.active { background: var(--gold); color: #000; font-weight: bold; box-shadow: 0 0 10px var(--gold-dim); }
        nav button.magic-btn:hover { color: var(--magic); }
        nav button.magic-btn.active { background: var(--magic); color: white; box-shadow: 0 0 10px var(--magic-dim); }

        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }

        /* === MAIN CONTENT === */
        main {
            padding: 30px; overflow-y: auto;
            background-image: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9)), url('https://www.transparenttextures.com/patterns/black-linen.png');
        }

        .section-view { display: none; animation: fadeIn 0.3s ease; }
        .section-view.active { display: block; }

        h2 { font-family: 'Cinzel'; border-bottom: 1px solid var(--gold-dim); padding-bottom: 10px; color: var(--gold); margin-top: 0; }
        h3 { color: var(--text-main); margin-bottom: 15px; border-left: 3px solid var(--gold); padding-left: 10px; }

        /* INPUTS & FORMS */
        input, select, textarea {
            background: #000; border: 1px solid #444; color: var(--gold);
            padding: 8px; border-radius: 4px; font-family: 'Roboto Mono', monospace; width: 100%;
            margin-bottom: 10px;
        }
        input:focus, textarea:focus { outline: 1px solid var(--gold); border-color: var(--gold); }
        
        .btn-action {
            background: #333; color: white; border: 1px solid #555; padding: 8px 15px; cursor: pointer; font-family: 'Cinzel';
            transition: 0.2s; width: 100%; text-transform: uppercase; font-size: 0.8rem;
        }
        .btn-action:hover { background: var(--gold); color: black; }
        .btn-danger { background: #4a0f0f; border-color: #ff4444; }
        .btn-danger:hover { background: #ff4444; color: white; }
        .btn-success { background: #1b4d1b; border-color: #44ff44; }
        .btn-magic { background: #4a235a; border-color: #9b59b6; }
        .btn-magic:hover { background: #9b59b6; color: white; }

        /* === GRID LAYOUTS === */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        .card {
            background: var(--card-bg); border: 1px solid var(--border); padding: 15px; border-radius: 8px;
            position: relative; transition: 0.2s;
        }
        .char-card { cursor: pointer; }
        .char-card:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        .spell-card { border-left: 3px solid var(--magic); margin-bottom: 10px; padding: 10px; background: rgba(74, 35, 90, 0.1); }
        .spell-card h4 { margin: 0 0 5px 0; color: var(--magic); display: flex; justify-content: space-between; }

        .bar-container { height: 8px; background: #333; margin: 5px 0; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; }

        /* === EDITOR DE FICHA (PC WIDE) === */
        #editor-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100; backdrop-filter: blur(5px);
            justify-content: center; align-items: center;
        }
        .editor-modal {
            background: #111; width: 90%; max-width: 1200px; height: 95%;
            border: 2px solid var(--gold); display: grid; grid-template-rows: 60px 1fr;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }
        .editor-header {
            padding: 0 20px; display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; border-bottom: 1px solid var(--border);
        }
        .editor-body {
            padding: 20px; overflow-y: auto; display: grid; 
            grid-template-columns: 250px 1fr 300px; gap: 20px;
        }

        .stat-box { background: #000; padding: 10px; text-align: center; border: 1px solid #333; border-radius: 4px; margin-bottom: 5px; }
        .stat-box label { font-size: 0.7rem; color: #666; display: block; text-transform: uppercase; }
        .stat-box input { text-align: center; font-size: 1.2rem; border: none; background: transparent; margin: 0; padding: 0; }

        .tag-skill {
            background: #112233; color: var(--skill); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--skill);
            font-size: 0.8rem; display: inline-flex; align-items: center; gap: 8px; margin-right: 5px; margin-bottom: 5px;
        }

        /* === ROOT EDITOR === */
        .json-editor {
            font-family: 'Roboto Mono', monospace; font-size: 0.9rem;
            background: #000; color: #0f0; border: 1px solid #333;
            width: 100%; height: 500px; resize: vertical; padding: 15px;
        }
        .root-controls { display: flex; gap: 10px; margin-bottom: 15px; background: #222; padding: 10px; border-radius: 6px; }

        /* UTILS */
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .col-half { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .badge { font-size: 0.6rem; padding: 2px 5px; background: #333; border-radius: 3px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<aside>
    <div class="brand"><i class="fas fa-dragon"></i> ZATUR</div>
    
    <nav>
        <button class="active" onclick="showSection('dashboard')"><i class="fas fa-users"></i> Personagens</button>
        <button onclick="showSection('world')"><i class="fas fa-globe"></i> Mundo & Miss√£o</button>
        <button onclick="showSection('combat')"><i class="fas fa-skull"></i> Combate & Mapa</button>
        <button class="magic-btn" onclick="showSection('grimoire')"><i class="fas fa-scroll"></i> Grim√≥rio (Magias)</button>
        <button onclick="showSection('forge')"><i class="fas fa-hammer"></i> Loja & Itens</button>
    </nav>

    <div class="sidebar-footer">
        <button onclick="showSection('root')" style="color: #ff5555; border: 1px dashed #ff5555;">
            <i class="fas fa-terminal"></i> ROOT / ADMIN
        </button>
    </div>
</aside>

<main>

    <div id="dashboard" class="section-view active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Grim√≥rio dos Jogadores</h2>
        </div>
        <div id="char-grid" class="char-grid"></div>
    </div>

    <div id="world" class="section-view">
        <h2>Controle de Narrativa</h2>
        <div class="col-half">
            <div class="card">
                <h3>üìú Miss√£o Atual</h3>
                <label>T√≠tulo</label>
                <input type="text" id="gm-mission-title">
                <label>Descri√ß√£o</label>
                <textarea id="gm-mission-desc" rows="4"></textarea>
                <button class="btn-action btn-success" onclick="updateGlobal()">Atualizar HUD</button>
            </div>
            <div class="card">
                <h3>üîä Audiovisual</h3>
                <label>M√∫sica (URL MP3)</label>
                <input type="text" id="gm-music">
                <label>Mapa (URL Imagem)</label>
                <input type="text" id="gm-map">
                <button class="btn-action" onclick="updateGlobalMedia()">Sincronizar M√≠dia</button>
            </div>
        </div>
    </div>

    <div id="combat" class="section-view">
        <h2>Painel T√°tico</h2>
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 20px;">
            <div class="card">
                <h3>‚öîÔ∏è Invocar Inimigo</h3>
                <input type="text" id="mob-name" placeholder="Nome (Ex: Orc Chefe)">
                <div class="col-half">
                    <input type="number" id="mob-pv" placeholder="PV">
                    <input type="text" id="mob-img" placeholder="URL Imagem">
                </div>
                <button class="btn-action btn-danger" onclick="spawnMob()">Adicionar ao Combate</button>
                <hr style="border-color:#333; margin:15px 0;">
                <button class="btn-action" onclick="clearCombat()" style="background:transparent; border:1px solid #444; color:#888;">Limpar Lista de Combate</button>
            </div>

            <div class="card">
                <h3>üìç Gest√£o de Tokens</h3>
                
                <label>1. Escolha o Tipo ou Personagem:</label>
                <select id="map-token-sel" onchange="checkTokenType()">
                    <option value="mob">Novo NPC / Monstro</option>
                    </select>

                <label style="margin-top:10px; display:block;">2. Nome (Para o Mapa):</label>
                <input type="text" id="token-custom-name" placeholder="Ex: Orc Furioso">

                <label>3. Imagem do Token (Link Direto):</label>
                <input type="text" id="token-custom-img" placeholder="https://i.ibb.co/...">

                <div class="flex-row" style="margin-top:15px;">
                    <button class="btn-action btn-success" onclick="addTokenMap()">Posicionar no Mapa</button>
                </div>

                <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
                    <button class="btn-action btn-danger" onclick="clearMapTokens()">Limpar Todos Tokens</button>
                </div>
            </div>
        </div>
    </div>

    <div id="grimoire" class="section-view">
        <h2 style="color:var(--magic); border-color:var(--magic);">Arcano: Cria√ß√£o de Magias</h2>
        
        <div class="grid-2">
            <div class="card" style="border-color:var(--magic-dim);">
                <h3 style="color:var(--magic)">‚ú® Inscrever Nova Magia</h3>
                <label>Nome da Magia</label>
                <input type="text" id="spell-name" placeholder="Ex: Bola de Fogo">
                <div class="col-half">
                    <div><label>Custo (PE)</label><input type="number" id="spell-cost" placeholder="0"></div>
                    <div><label>C√≠rculo</label><input type="number" id="spell-circle" placeholder="1"></div>
                </div>
                <div class="col-half">
                    <div><label>Dano</label><input type="text" id="spell-dmg" placeholder="Ex: 2d6"></div>
                    <div><label>B√¥nus</label><input type="text" id="spell-bonus" placeholder="Ex: Queima"></div>
                </div>
                <label>Descri√ß√£o</label>
                <textarea id="spell-desc" rows="3" placeholder="Explique como a magia funciona..."></textarea>
                <button class="btn-action btn-magic" onclick="createSpell()">Inscrever no Grim√≥rio</button>
            </div>

            <div class="card">
                <h3>üìö Arquivos Arcanos</h3>
                <div id="spell-list" style="max-height: 500px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <div id="forge" class="section-view">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Forja & Mercado</h2>
            <button id="shop-status-btn" onclick="toggleShop()" style="width:auto; padding:10px 30px;" class="btn-action btn-danger">LOJA FECHADA</button>
        </div>
        
        <div class="card" style="max-width:600px; margin-top:20px;">
            <h3>‚öíÔ∏è Criar Novo Item</h3>
            <input type="text" id="new-item-name" placeholder="Nome do Item">
            <div class="col-half">
                <input type="number" id="new-item-price" placeholder="Pre√ßo ($)">
                <input type="text" id="new-item-img" placeholder="URL Imagem (Opcional)">
            </div>
            <textarea id="new-item-desc" placeholder="Descri√ß√£o..." rows="2"></textarea>
            <button class="btn-action btn-success" onclick="createNewItem()">Forjar Item</button>
        </div>
    </div>

    <div id="root" class="section-view">
        <h2 style="color:#ff5555; border-color:#ff5555;">ROOT ACCESS</h2>
        <div style="background:#111; padding:20px; border:1px solid #ff5555;">
            <div class="root-controls">
                <select id="root-collection" onchange="loadRootCollection()">
                    <option value="">-- Selecione a Cole√ß√£o --</option>
                    <option value="characters">Personagens</option>
                    <option value="items">Itens</option>
                    <option value="spells">Magias</option>
                    <option value="campaign_settings">Configura√ß√µes</option>
                    <option value="active_encounters">Combate Ativo</option>
                    <option value="logs">Logs (Chat/Rolls)</option>
                </select>
                <select id="root-document" onchange="loadRootDocument()"><option value="">-- ID --</option></select>
                <button onclick="downloadBackup()" class="btn-action" style="width:auto; margin-left:auto; background:#333;">‚¨áÔ∏è Baixar JSON</button>
            </div>
            <textarea id="root-editor" class="json-editor" spellcheck="false" placeholder="Selecione um documento para editar o JSON bruto..."></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                <button onclick="saveRootEdit()" class="btn-action btn-danger" style="width:auto; padding:10px 30px;">‚ö° SALVAR BRUTO</button>
            </div>
        </div>
    </div>

</main>

<div id="editor-overlay">
    <div class="editor-modal">
        <div class="editor-header">
            <h2 id="modal-char-name" style="margin:0; border:none;">Nome Personagem</h2>
            <div class="flex-row">
                <button class="btn-action btn-success" onclick="saveCharacter()" style="width:auto;">üíæ Salvar</button>
                <button class="btn-action btn-danger" onclick="closeEditor()" style="width:auto;">X</button>
            </div>
        </div>
        
        <div class="editor-body">
            <div style="border-right:1px solid #333; padding-right:15px;">
                <h3>Status</h3>
                <div class="stat-box">
                    <label>Vida Atual</label><input type="number" id="inp-pv">
                    <label>M√°xima</label><input type="number" id="inp-pv-max" style="font-size:0.9rem; color:#888;">
                </div>
                <div class="stat-box" style="border-color:#003366;">
                    <label>Mana Atual</label><input type="number" id="inp-pe" style="color:#aaf;">
                    <label>M√°xima</label><input type="number" id="inp-pe-max" style="font-size:0.9rem; color:#668;">
                </div>
                <div class="stat-box" style="border-color:#665500;">
                    <label>XP</label><input type="number" id="inp-xp" style="color:#ffebb5;">
                </div>
                <div class="stat-box" style="border-color:#665500;">
                    <label>Zeuros ($)</label><input type="number" id="inp-zeuro" style="color:gold;">
                </div>
                <div style="margin-top:20px;">
                     <label style="font-size:0.8rem; color:#666;">CLASSE</label>
                     <input type="text" id="inp-classe">
                </div>
            </div>

            <div style="padding:0 15px;">
                <h3>Atributos</h3>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:20px;">
                    <div class="stat-box"><label>FOR</label><input id="inp-for"></div>
                    <div class="stat-box"><label>AGI</label><input id="inp-agi"></div>
                    <div class="stat-box"><label>INT</label><input id="inp-int"></div>
                    <div class="stat-box"><label>VIG</label><input id="inp-vig"></div>
                    <div class="stat-box"><label>PRE</label><input id="inp-pre"></div>
                    <div class="stat-box"><label>MAN</label><input id="inp-man"></div>
                </div>

                <div style="background:#151515; padding:10px; border-radius:6px; border:1px solid #333; margin-bottom:20px;">
                    <h3 style="margin-top:0; font-size:1rem; color:var(--skill);">Per√≠cias & Treinos</h3>
                    <div class="flex-row" style="margin-bottom:10px;">
                        <input type="text" id="new-pericia-name" placeholder="Ex: Furtividade" style="margin:0;">
                        <input type="number" id="new-pericia-bonus" placeholder="+0" style="width:60px; margin:0;">
                        <button onclick="addPericiaChar()" class="btn-action" style="width:auto;">+</button>
                    </div>
                    <div id="modal-pericias-list" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
                </div>

                <div class="col-half">
                    <div><label>Defesa</label><input type="number" id="inp-def"></div>
                    <div><label>Deslocamento</label><input type="text" id="inp-desl"></div>
                </div>

                <label style="margin-top:10px; display:block;">Hist√≥ria / Bio</label>
                <textarea id="inp-bio" rows="4"></textarea>
                <label>Avatar URL</label><input type="text" id="inp-avatar">
            </div>

            <div style="border-left:1px solid #333; padding-left:15px;">
                <h3>Mochila & Poderes</h3>
                
                <div style="background:#1a1a1a; padding:10px; border-radius:4px; margin-bottom:10px;">
                    <label>Item:</label>
                    <div class="flex-row">
                        <select id="modal-item-list" style="margin:0;"></select>
                        <button onclick="addItemChar()" class="btn-action" style="width:auto;">+</button>
                    </div>
                </div>
                <div id="modal-inv-list" style="max-height:150px; overflow-y:auto; margin-bottom:20px;"></div>

                <div style="background:#1a1a1a; padding:10px; border-radius:4px;">
                    <label>Habilidade/Magia:</label>
                    <div class="flex-row">
                        <select id="modal-spell-list" style="margin:0;"></select>
                        <button onclick="addSkillFromList()" class="btn-action" style="width:auto;">+</button>
                    </div>
                    <input type="text" id="modal-new-skill" placeholder="Manual..." style="margin-top:5px;">
                    <button onclick="addSkillManual()" class="btn-action" style="width:100%; margin-top:5px;">Add</button>
                </div>
                <div id="modal-skill-list" style="max-height:200px; overflow-y:auto; margin-top:5px;"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, getDocs, addDoc, arrayUnion, arrayRemove, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgYVod9B99WIc_QysFx73htOf9O8XtuE8",
        authDomain: "zatur-rpg.firebaseapp.com",
        projectId: "zatur-rpg",
        storageBucket: "zatur-rpg.firebasestorage.app",
        messagingSenderId: "797058283992",
        appId: "1:797058283992:web:7132e71691a225c1255aad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let activeCharId = null;
    let itemsCache = {}; 
    let spellsCache = {}; 
    let currentRootCollection = "";

    window.showSection = (id) => {
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    };

    async function init() {
        // Load Items
        const itemsSnap = await getDocs(collection(db, "items"));
        const itemSel = document.getElementById('modal-item-list');
        itemSel.innerHTML = "";
        itemsSnap.forEach(d => {
            const i = d.data();
            itemsCache[d.id] = i.Nome;
            itemSel.innerHTML += `<option value="${d.id}">${i.Nome} ($${i.Preco})</option>`;
        });

        // Load Spells
        onSnapshot(collection(db, "spells"), (snap) => {
            const spellListDiv = document.getElementById('spell-list');
            const spellSel = document.getElementById('modal-spell-list');
            spellListDiv.innerHTML = "";
            spellSel.innerHTML = "<option value=''>-- Selecionar Magia --</option>";
            
            snap.forEach(d => {
                const s = d.data();
                spellsCache[d.id] = s.Nome;
                const div = document.createElement('div');
                div.className = "spell-card";
                div.innerHTML = `
                    <h4>${s.Nome} <span style="font-size:0.7rem; color:#aaa;">Custo: ${s.Custo||0} PE</span></h4>
                    <div style="font-size:0.8rem; color:#ddd;">Dano: ${s.Dano||'-'} | B√¥nus: ${s.Bonus||'-'}</div>
                    <button onclick="deleteSpell('${d.id}')" style="margin-top:5px; background:none; color:#ff5555; border:1px solid #ff5555; cursor:pointer;">Excluir</button>
                `;
                spellListDiv.appendChild(div);
                spellSel.innerHTML += `<option value="${s.Nome}">${s.Nome} (${s.Custo} PE)</option>`;
            });
        });

        // Load Characters
        onSnapshot(collection(db, "characters"), (snap) => {
            const grid = document.getElementById('char-grid');
            const tokenSel = document.getElementById('map-token-sel');
            grid.innerHTML = "";
            tokenSel.innerHTML = "<option value='mob'>NPC / Monstro</option>";

            snap.forEach(d => {
                const c = d.data();
                const id = d.id;
                const hpPct = Math.min(100, (c.PV / (c.PV_Max||1))*100);
                const mpPct = Math.min(100, (c.PE / (c.PE_Max||1))*100);

                const div = document.createElement('div');
                div.className = 'char-card card';
                div.onclick = () => openEditor(id);
                div.innerHTML = `
                    <div class="flex-row" style="justify-content:space-between">
                        <strong style="font-size:1.1rem; color:var(--gold)">${c.Nome}</strong>
                        <span class="badge">${c.Classe || '-'}</span>
                    </div>
                    <div class="bar-container"><div class="bar-fill" style="width:${hpPct}%; background:${hpPct<30?'#ff4444':'#44ff44'}"></div></div>
                    <div class="bar-container"><div class="bar-fill" style="width:${mpPct}%; background:#4444ff"></div></div>
                `;
                grid.appendChild(div);
                const opt = document.createElement('option');
                opt.value = id; opt.innerText = c.Nome;
                tokenSel.appendChild(opt);
            });
        });

        // Global Settings
        onSnapshot(doc(db, "campaign_settings", "global"), (snap) => {
            const g = snap.data();
            if(!g) return;
            document.getElementById('gm-mission-title').value = g.missao_titulo || "";
            document.getElementById('gm-mission-desc').value = g.missao_desc || "";
            document.getElementById('gm-music').value = g.musica_url || "";
            document.getElementById('gm-map').value = g.mapa_url || "";
            const btnShop = document.getElementById('shop-status-btn');
            if(g.loja_aberta) { btnShop.innerText = "LOJA ABERTA"; btnShop.className = "btn-action btn-success"; } 
            else { btnShop.innerText = "LOJA FECHADA"; btnShop.className = "btn-action btn-danger"; }
        });
    }
    init();

    // --- GRIM√ìRIO ---
    window.createSpell = async () => {
        const nome = document.getElementById('spell-name').value;
        if(!nome) return alert("Nome obrigat√≥rio!");
        await addDoc(collection(db, "spells"), {
            Nome: nome,
            Custo: parseInt(document.getElementById('spell-cost').value) || 0,
            Circulo: parseInt(document.getElementById('spell-circle').value) || 1,
            Dano: document.getElementById('spell-dmg').value,
            Bonus: document.getElementById('spell-bonus').value,
            Descricao: document.getElementById('spell-desc').value
        });
        document.getElementById('spell-name').value = "";
    };
    window.deleteSpell = async (id) => { if(confirm("Apagar magia?")) await deleteDoc(doc(db, "spells", id)); };

    // --- MODAL EDITOR & PER√çCIAS ---
    window.openEditor = (id) => {
        activeCharId = id;
        document.getElementById('editor-overlay').style.display = 'flex';
        
        onSnapshot(doc(db, "characters", id), (snap) => {
            if(!activeCharId || activeCharId !== id) return;
            const d = snap.data();
            document.getElementById('modal-char-name').innerText = d.Nome;
            
            const map = {
                'inp-pv': d.PV, 'inp-pv-max': d.PV_Max,
                'inp-pe': d.PE, 'inp-pe-max': d.PE_Max,
                'inp-xp': d.XP, 'inp-zeuro': d.Zeuro,
                'inp-for': d.For√ßa, 'inp-agi': d.Agilidade, 'inp-int': d.Intelecto,
                'inp-vig': d.Vigor, 'inp-pre': d.Presen√ßa, 'inp-man': d.Mana,
                'inp-def': d.Defesa_Total, 'inp-desl': d.Deslocamento, 'inp-classe': d.Classe,
                'inp-bio': d.Historia, 'inp-avatar': d.AvatarURL
            };
            for(let k in map) {
                const el = document.getElementById(k);
                if(el) el.value = map[k] !== undefined ? map[k] : "";
            }

            renderModalList('modal-inv-list', d.itens || [], 'itens', true);
            renderModalList('modal-skill-list', d.habilidades || [], 'habilidades', false);
            renderPericiasList(d.pericias || []);
        });
    };

    window.closeEditor = () => { document.getElementById('editor-overlay').style.display = 'none'; activeCharId = null; };

    function renderModalList(divId, list, field, useCache) {
        const div = document.getElementById(divId);
        div.innerHTML = "";
        list.forEach(item => {
            let label = item;
            if(useCache && itemsCache[item]) label = itemsCache[item];
            div.innerHTML += `
                <div class="flex-row" style="background:#222; padding:5px; margin-bottom:2px; font-size:0.85rem;">
                    <span style="flex-grow:1">${label}</span>
                    <button class="btn-danger" style="width:auto; padding:2px 6px;" onclick="removeItemChar('${field}','${item}')">X</button>
                </div>`;
        });
    }

    function renderPericiasList(list) {
        const div = document.getElementById('modal-pericias-list');
        div.innerHTML = "";
        list.forEach(item => {
            div.innerHTML += `
                <div class="tag-skill">
                    ${item}
                    <i class="fas fa-times" style="cursor:pointer; color:#ff5555" onclick="removeItemChar('pericias','${item}')"></i>
                </div>`;
        });
    }

    window.addPericiaChar = async () => {
        const nome = document.getElementById('new-pericia-name').value;
        const bonus = document.getElementById('new-pericia-bonus').value;
        
        if(activeCharId && nome) {
            const val = `${nome} (${bonus >= 0 ? '+' : ''}${bonus})`;
            await updateDoc(doc(db, "characters", activeCharId), { pericias: arrayUnion(val) });
            document.getElementById('new-pericia-name').value = "";
            document.getElementById('new-pericia-bonus').value = "";
        }
    };

    window.addItemChar = async () => {
        const val = document.getElementById('modal-item-list').value;
        if(activeCharId && val) await updateDoc(doc(db,"characters",activeCharId), { itens: arrayUnion(val) });
    };

    window.addSkillFromList = async () => {
        const val = document.getElementById('modal-spell-list').value;
        if(activeCharId && val) await updateDoc(doc(db,"characters",activeCharId), { habilidades: arrayUnion(val) });
    };

    window.addSkillManual = async () => {
        const val = document.getElementById('modal-new-skill').value;
        if(activeCharId && val) {
            await updateDoc(doc(db,"characters",activeCharId), { habilidades: arrayUnion(val) });
            document.getElementById('modal-new-skill').value = "";
        }
    };

    window.removeItemChar = async (field, val) => {
        if(activeCharId) await updateDoc(doc(db,"characters",activeCharId), { [field]: arrayRemove(val) });
    };

    window.saveCharacter = async () => {
        if(!activeCharId) return;
        const data = {
            PV: parseInt(document.getElementById('inp-pv').value) || 0,
            PV_Max: parseInt(document.getElementById('inp-pv-max').value) || 0,
            PE: parseInt(document.getElementById('inp-pe').value) || 0,
            PE_Max: parseInt(document.getElementById('inp-pe-max').value) || 0,
            XP: parseInt(document.getElementById('inp-xp').value) || 0,
            Zeuro: parseInt(document.getElementById('inp-zeuro').value) || 0,
            For√ßa: parseInt(document.getElementById('inp-for').value) || 0,
            Agilidade: parseInt(document.getElementById('inp-agi').value) || 0,
            Intelecto: parseInt(document.getElementById('inp-int').value) || 0,
            Vigor: parseInt(document.getElementById('inp-vig').value) || 0,
            Presen√ßa: parseInt(document.getElementById('inp-pre').value) || 0,
            Mana: parseInt(document.getElementById('inp-man').value) || 0,
            Defesa_Total: parseInt(document.getElementById('inp-def').value) || 0,
            Deslocamento: document.getElementById('inp-desl').value,
            Historia: document.getElementById('inp-bio').value,
            AvatarURL: document.getElementById('inp-avatar').value,
            Classe: document.getElementById('inp-classe').value
        };
        await updateDoc(doc(db, "characters", activeCharId), data);
        closeEditor();
    };

    // --- A√á√ïES GLOBAIS / MESTRE ---
    window.updateGlobal = async () => {
        await updateDoc(doc(db, "campaign_settings", "global"), {
            missao_titulo: document.getElementById('gm-mission-title').value,
            missao_desc: document.getElementById('gm-mission-desc').value
        });
        alert("Miss√£o Atualizada!");
    };
    window.updateGlobalMedia = async () => {
        await updateDoc(doc(db, "campaign_settings", "global"), {
            musica_url: document.getElementById('gm-music').value,
            mapa_url: document.getElementById('gm-map').value
        });
    };
    window.toggleShop = async () => {
        const btn = document.getElementById('shop-status-btn');
        await updateDoc(doc(db, "campaign_settings", "global"), { loja_aberta: btn.innerText.includes("FECHADA") });
    };
    window.spawnMob = async () => {
        await addDoc(collection(db, "active_encounters"), {
            Nome: document.getElementById('mob-name').value || "Inimigo",
            PV: parseInt(document.getElementById('mob-pv').value) || 10,
            PV_Max: parseInt(document.getElementById('mob-pv').value) || 10,
            Imagem: document.getElementById('mob-img').value || ""
        });
    };
    window.clearCombat = async () => {
        const q = await getDocs(collection(db, "active_encounters"));
        q.forEach(d => deleteDoc(d.ref));
    };
    window.addTokenMap = async () => {
        const sel = document.getElementById('map-token-sel');
        const id = sel.value === 'mob' ? 'npc_'+Date.now() : sel.value;
        const name = sel.options[sel.selectedIndex].text;
        // Posi√ß√£o padr√£o 50,50 para evitar criar fora da tela
        await updateDoc(doc(db, "campaign_settings", "global"), {
            [`posicoes.${id}`]: { x: 50, y: 50, nome: name, size: 40 }
        });
    };
    window.clearMapTokens = async () => { if(confirm("Limpar mapa?")) await updateDoc(doc(db, "campaign_settings", "global"), { posicoes: {} }); };
    window.createNewItem = async () => {
        await addDoc(collection(db, "items"), {
            Nome: document.getElementById('new-item-name').value,
            Preco: parseInt(document.getElementById('new-item-price').value) || 0,
            Descricao: document.getElementById('new-item-desc').value,
            Imagem: document.getElementById('new-item-img').value
        });
        alert("Item Forjado!");
    };

    // --- ROOT / ADMIN SYSTEM ---
    window.loadRootCollection = async () => {
        const col = document.getElementById('root-collection').value;
        const sel = document.getElementById('root-document');
        const editor = document.getElementById('root-editor');
        sel.innerHTML = "<option value=''>Carregando...</option>";
        editor.value = "";
        
        if(!col) return;
        currentRootCollection = col;
        
        const q = await getDocs(collection(db, col));
        sel.innerHTML = "<option value=''>-- Selecione ID --</option>";
        q.forEach(d => {
            // Tenta achar um nome leg√≠vel ou usa ID
            const data = d.data();
            const label = data.Nome || data.title || d.id;
            sel.innerHTML += `<option value="${d.id}">${label} (${d.id})</option>`;
        });
    };

    window.loadRootDocument = async () => {
        const id = document.getElementById('root-document').value;
        if(!id) return;
        
        const snap = await getDoc(doc(db, currentRootCollection, id));
        if(snap.exists()) {
            document.getElementById('root-editor').value = JSON.stringify(snap.data(), null, 4);
        }
    };

    window.saveRootEdit = async () => {
        const col = currentRootCollection;
        const id = document.getElementById('root-document').value;
        const txt = document.getElementById('root-editor').value;
        
        if(!col || !id || !txt) return;
        
        try {
            const json = JSON.parse(txt);
            await setDoc(doc(db, col, id), json); // setDoc sobrescreve ou cria, ideal para root
            alert("Documento atualizado com Sucesso Absoluto.");
        } catch(e) {
            alert("ERRO DE JSON: " + e.message);
        }
    };

    window.downloadBackup = () => {
        const txt = document.getElementById('root-editor').value;
        if(!txt) return alert("Nada carregado para baixar.");
        const blob = new Blob([txt], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${currentRootCollection}_${Date.now()}.json`;
        a.click();
    }

    // Fun√ß√£o auxiliar para preencher o nome automaticamente ao selecionar player
    window.checkTokenType = () => {
        const sel = document.getElementById('map-token-sel');
        const nameInput = document.getElementById('token-custom-name');
        if (sel.value !== 'mob') {
            nameInput.value = sel.options[sel.selectedIndex].text;
        } else {
            nameInput.value = "";
        }
    }

    window.addTokenMap = async () => {
        const sel = document.getElementById('map-token-sel');
        const customImg = document.getElementById('token-custom-img').value;
        const customName = document.getElementById('token-custom-name').value;
        
        let id = sel.value;
        let finalName = customName || "Desconhecido";

        // Se for MOB, cria um ID √∫nico para permitir v√°rios monstros iguais
        if (id === 'mob') {
            id = 'mob_' + Date.now();
        }

        // Dados do Token
        const tokenData = {
            x: 100, // Posi√ß√£o inicial padr√£o
            y: 100,
            size: 60, // Tamanho padr√£o
            name: finalName,
            // Se tiver imagem customizada, usa ela. 
            // Se for player e n√£o tiver imagem customizada, o renderMap l√° do player 
            // deve tentar pegar o avatar do personagem pelo ID, mas aqui garantimos o link se fornecido.
            img: customImg || "" 
        };

        // Salva na configura√ß√£o global (usando a nota√ß√£o de ponto para atualizar chaves espec√≠ficas)
        // Isso requer que voc√™ importe 'updateDoc' e 'doc' do firebase
        try {
            await updateDoc(doc(db, "campaign_settings", "global"), {
                [`posicoes.${id}`]: tokenData
            });
            alert("Token adicionado com sucesso!");
        } catch (error) {
            console.error("Erro ao adicionar token:", error);
            alert("Erro ao adicionar token (verifique o console).");
        }
    };

    window.clearMapTokens = async () => {
        if(confirm("Tem certeza que deseja remover TODOS os tokens do mapa?")) {
            await updateDoc(doc(db, "campaign_settings", "global"), {
                posicoes: {}
            });
        }
    };
</script>
</body>
</html>
