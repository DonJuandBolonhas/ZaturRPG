<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zatur - Grim칩rio do Mestre</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=MedievalSharp&family=Lora:wght@400;700&display=swap');
        
        :root {
            --gold: #d4af37; --gold-dark: #8a7018; 
            --bg: #0b0704; --panel: #16100a; 
            --border: #4b2e0e; --danger: #5a1515; --success: #1e4215;
            --text: #cbbfa3;
        }

        body {
            font-family: 'MedievalSharp', cursive; background: var(--bg); color: var(--text); margin: 0;
            display: grid; grid-template-columns: 350px 1fr; height: 100vh; overflow: hidden;
        }

        /* BARRA LATERAL */
        aside {
            background: var(--panel); border-right: 3px solid var(--gold); padding: 15px;
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto;
            box-shadow: 5px 0 15px black; z-index: 10;
        }

        h1, h2, h3 { font-family: 'Cinzel'; color: var(--gold); margin: 0 0 10px 0; text-shadow: 1px 1px 2px black; }
        h1 { text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.8rem; }

        .control-group { background: rgba(0,0,0,0.4); padding: 12px; border: 1px solid var(--border); border-radius: 6px; }
        .control-group h2 { font-size: 0.95rem; border-bottom: 1px dashed #333; padding-bottom: 5px; margin-bottom: 10px; color:#ddd;}
        .control-group label { display: block; font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 3px; margin-top: 8px; }
        
        input, select, textarea {
            width: 100%; padding: 6px; background: #000; border: 1px solid #444; color: var(--gold);
            font-family: 'Lora'; box-sizing: border-box; border-radius: 4px; font-size: 0.9rem;
        }
        input:focus, select:focus, textarea:focus { outline: 1px solid var(--gold); border-color: var(--gold); }

        button {
            width: 100%; padding: 8px; background: linear-gradient(to bottom, #3a220a, #1a0f06); 
            color: var(--gold); border: 1px solid var(--gold-dark); cursor: pointer; 
            font-family: 'Cinzel'; font-weight: bold; transition: 0.2s; margin-top: 10px; font-size: 0.8rem;
        }
        button:hover { background: var(--gold); color: #000; }
        button.danger { background: var(--danger); border-color: #ff4444; color: #ffcccc; }
        button.success { background: var(--success); border-color: #44ff44; color: #ccffcc; }

        /* 츼REA PRINCIPAL */
        main { 
            padding: 30px; overflow-y: auto; 
            background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');
            position: relative;
        }

        .empty-state {
            text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            opacity: 0.3; pointer-events: none;
        }

        #editor-panel { display: none; max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }
        
        .char-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 3px double var(--gold); padding-bottom: 10px; margin-bottom: 20px;
        }

        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .card { 
            background: rgba(22, 16, 10, 0.9); border: 1px solid var(--border); padding: 15px; 
            border-radius: 6px; position: relative;
        }
        .card h3 { border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 1rem; }

        .vitals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .vital-box { text-align: center; background: #000; padding: 10px; border: 1px solid #333; }
        .vital-box label { color: var(--gold); font-size: 0.8rem; display: block; }
        .vital-box input { text-align: center; font-size: 1.5rem; border: none; background: transparent; color: white; font-family: 'MedievalSharp'; margin-top:0; }

        .item-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px; border-bottom: 1px solid #333; font-size: 0.9rem; 
        }
        .btn-mini { width: auto; padding: 2px 8px; margin: 0; font-size: 0.8rem; }
        
        /* Highlight para diferenciar se칞칫es */
        .section-icon { margin-right: 5px; }
    </style>
</head>
<body>

<aside>
    <div>
        <h1>ZATUR RPG</h1>
        <div style="text-align:center; font-size:0.7rem; color:#666;">PAINEL DO MESTRE v3.0</div>
    </div>

    <div class="control-group">
        <h2>游닆 Narrativa / Miss칚o</h2>
        <input type="text" id="gm-mission-title" placeholder="T칤tulo (Ex: A Tumba)">
        <textarea id="gm-mission-desc" rows="2" placeholder="Descri칞칚o da miss칚o..."></textarea>
        <button onclick="updateMission()">Atualizar HUD Jogadores</button>
    </div>

    <div class="control-group">
        <h2>游깴 Cen치rio & Som</h2>
        <label>Imagem do Mapa (URL)</label>
        <input type="text" id="global-map" placeholder="http://...">
        
        <label>M칰sica de Fundo (MP3 URL)</label>
        <input type="text" id="global-music" placeholder="http://... .mp3">
        
        <button id="btn-update-world">Sincronizar Mesa</button>
        <button class="danger" onclick="clearTokens()" style="margin-top:5px; font-size:0.7rem">Limpar Todos Tokens</button>
    </div>

    <div class="control-group">
        <h2>游늸 Novo Token no Mapa</h2>
        
        <label>Vincular a Jogador (Opcional)</label>
        <select id="token-player-select" onchange="autoFillToken()">
            <option value="">-- Nenhum (Monstro/NPC) --</option>
        </select>

        <label>Nome do Token</label>
        <input type="text" id="token-custom-name" placeholder="Ex: Orc ou Nome do Jogador">

        <label>Imagem do Token (URL)</label>
        <input type="text" id="token-custom-img" placeholder="Deixe vazio para usar a da ficha">

        <button onclick="addMapToken()" style="background:#444; color:white; border:1px solid #666;">Colocar no Mapa</button>
    </div>

    <div class="control-group">
        <h2>丘덢잺 Spawnar Inimigo (Combate)</h2>
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:5px;">
            <input type="text" id="mob-name" placeholder="Nome (Orc)">
            <input type="number" id="mob-hp" placeholder="PV" value="20">
        </div>
        <input type="text" id="mob-img" placeholder="URL Imagem" style="margin-top:5px">
        <button class="danger" onclick="spawnMonster()">Adicionar ao Tracker</button>
        <button onclick="clearMonsters()" style="background:none; border:none; color:#666; font-size:0.7rem; padding:0; margin-top:5px;">(Limpar Lista de Combate)</button>
    </div>

    <div class="control-group">
        <h2>丘뉦잺 Forjar Item/Skill</h2>
        <select id="new-type" style="margin-bottom:5px">
            <option value="items">Item (Equipamento)</option>
            <option value="skills">Per칤cia (Habilidade)</option>
        </select>
        
        <input type="text" id="new-item-name" placeholder="Nome">
        <textarea id="new-item-desc" rows="1" placeholder="Efeito..."></textarea>
        
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:5px; margin-top:5px;">
            <div>
                <label style="margin:0">Pre칞o ($)</label>
                <input type="number" id="new-item-price" value="0">
            </div>
            <div>
                <label style="margin:0">Imagem (URL)</label>
                <input type="text" id="new-item-img">
            </div>
        </div>
        <small style="color:#666; font-size:0.6rem">* Pre칞o 0 = N칚o aparece na loja</small>

        <button id="btn-create-entry" class="success">Salvar no Banco</button>
    </div>

    <div class="control-group" style="border-color:var(--gold);">
        <h2>游닇 Editar Ficha</h2>
        <select id="edit-player-select">
            <option value="">-- Selecione para Editar --</option>
        </select>
    </div>
</aside>

<main>
    <div class="empty-state" id="empty-msg">
        <h1>Grim칩rio do Mestre<br><span style="font-size:1rem; font-family:'Lora'">Selecione um personagem abaixo para editar</span></h1>
    </div>

    <div id="editor-panel">
        <div class="char-header">
            <div>
                <h1 id="char-name" style="text-align:left; border:none; padding:0; font-size:2.5rem">-</h1>
                <span id="char-desc" style="color:#888;">Classe | Origem</span>
            </div>
            <button onclick="saveCharacter()" style="width:auto; padding: 10px 30px; background:var(--gold); color:black;">游 SALVAR FICHA</button>
        </div>

        <div class="grid-dashboard">
            <div class="card">
                <h3>仇벒잺 Vitais & Recursos</h3>
                <div class="vitals-grid">
                    <div class="vital-box"><label>VIDA ATUAL</label><input type="number" id="inp-pv"></div>
                    <div class="vital-box"><label>VIDA M츼X</label><input type="number" id="inp-pv-max"></div>
                    <div class="vital-box"><label>MANA ATUAL</label><input type="number" id="inp-pe"></div>
                    <div class="vital-box"><label>MANA M츼X</label><input type="number" id="inp-pe-max"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>XP</label><input type="number" id="inp-xp"></div>
                    <div><label>Zeuros ($)</label><input type="number" id="inp-gold"></div>
                </div>
            </div>

            <div class="card">
                <h3>游늵 Atributos</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>FOR칂A</label><input type="number" id="inp-for"></div>
                    <div><label>AGILIDADE</label><input type="number" id="inp-agi"></div>
                    <div><label>MANA (Attr)</label><input type="number" id="inp-man"></div>
                    <div><label>INTELECTO</label><input type="number" id="inp-int"></div>
                    <div><label>VIGOR</label><input type="number" id="inp-vig"></div>
                    <div><label>DEFESA</label><input type="number" id="inp-def-eq"></div>
                </div>
            </div>

            <div class="card">
                <h3>游 Invent치rio</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="list-global-inv"></select>
                    <button class="btn-mini" onclick="addEntryToChar('itens', 'list-global-inv')">+</button>
                </div>
                <div id="container-inv" style="max-height:200px; overflow-y:auto;"></div>
            </div>

            <div class="card">
                <h3>游닆 Habilidades</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="list-global-skill"></select>
                    <button class="btn-mini" onclick="addEntryToChar('pericias', 'list-global-skill')">+</button>
                </div>
                <div id="container-skill" style="max-height:200px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, getDocs, addDoc, arrayUnion, arrayRemove, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgYVod9B99WIc_QysFx73htOf9O8XtuE8",
        authDomain: "zatur-rpg.firebaseapp.com",
        projectId: "zatur-rpg",
        storageBucket: "zatur-rpg.firebasestorage.app",
        messagingSenderId: "797058283992",
        appId: "1:797058283992:web:7132e71691a225c1255aad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentCharId = null;
    let globalNameCache = {}; 

    // === INICIALIZA칂츾O ===
    async function init() {
        // Carrega Lista de Personagens para os dois selects (Edi칞칚o e Token)
        const charsSnap = await getDocs(collection(db, "characters"));
        const editSel = document.getElementById('edit-player-select');
        const tokenSel = document.getElementById('token-player-select');
        
        charsSnap.forEach(d => {
            const opt = `<option value="${d.id}">${d.data().Nome}</option>`;
            editSel.innerHTML += opt;
            tokenSel.innerHTML += opt;
        });

        // Carrega Configs Globais
        const globalSnap = await getDoc(doc(db, "campaign_settings", "global"));
        if(globalSnap.exists()) {
            const gd = globalSnap.data();
            document.getElementById('gm-mission-title').value = gd.missao_titulo || "";
            document.getElementById('gm-mission-desc').value = gd.missao_desc || "";
            document.getElementById('global-map').value = gd.mapa_url || "";
            document.getElementById('global-music').value = gd.musica_url || "";
        }
        refreshGlobalData();
    }
    init();

    // === 1. TOKENS DO MAPA (L칩gica Nova) ===
    window.autoFillToken = async () => {
        const pid = document.getElementById('token-player-select').value;
        if(pid) {
            // Se selecionou jogador, busca nome
            const snap = await getDoc(doc(db, "characters", pid));
            if(snap.exists()) {
                document.getElementById('token-custom-name').value = snap.data().Nome;
                // Deixa imagem vazia para usar padr칚o ou o mestre escolhe outra
            }
        } else {
            document.getElementById('token-custom-name').value = "";
        }
    };

    window.addMapToken = async () => {
        const pid = document.getElementById('token-player-select').value;
        const name = document.getElementById('token-custom-name').value;
        const img = document.getElementById('token-custom-img').value;

        if(!name) return alert("O token precisa de um nome!");

        // Se tiver PID, usa ele como chave (para linkar status). Se n칚o, cria ID aleat칩rio.
        const tokenId = pid ? pid : "npc_" + Date.now();
        
        const tokenData = {
            x: 50, // Posi칞칚o padr칚o
            y: 50,
            nome: name,
            img: img // Se vazio, o sistema do mapa deve lidar com isso ou usar imagem padr칚o
        };

        await updateDoc(doc(db, "campaign_settings", "global"), {
            [`posicoes.${tokenId}`]: tokenData
        });
        
        alert("Token posicionado no (50,50)!");
    };

    window.clearTokens = async () => {
        if(confirm("ATEN칂츾O: Isso remover치 TODOS os tokens do mapa. Continuar?")) {
            await updateDoc(doc(db, "campaign_settings", "global"), { posicoes: {} });
        }
    };

    // === 2. CEN츼RIO & SOM ===
    document.getElementById('btn-update-world').onclick = async () => {
        await updateDoc(doc(db, "campaign_settings", "global"), {
            mapa_url: document.getElementById('global-map').value,
            musica_url: document.getElementById('global-music').value
        });
        alert("Mapa e M칰sica atualizados!");
    };

    // === 3. FORJA (Com Pre칞o e Imagem) ===
    document.getElementById('btn-create-entry').onclick = async () => {
        const col = document.getElementById('new-type').value;
        const nome = document.getElementById('new-item-name').value;
        const preco = parseInt(document.getElementById('new-item-price').value) || 0;
        const img = document.getElementById('new-item-img').value;
        
        if(!nome) return alert("Nome obrigat칩rio");

        await addDoc(collection(db, col), {
            Nome: nome,
            Descricao: document.getElementById('new-item-desc').value,
            Preco: preco,
            Imagem: img
        });
        
        alert(`Item criado! Pre칞o: ${preco}`);
        document.getElementById('new-item-name').value = "";
        refreshGlobalData();
    };

    // === 4. EDI칂츾O DE FICHA ===
    document.getElementById('edit-player-select').onchange = (e) => {
        currentCharId = e.target.value;
        if(currentCharId) {
            document.getElementById('empty-msg').style.display = 'none';
            document.getElementById('editor-panel').style.display = 'block';
            subscribeToChar(currentCharId);
        } else {
            document.getElementById('empty-msg').style.display = 'block';
            document.getElementById('editor-panel').style.display = 'none';
        }
    };

    function subscribeToChar(id) {
        onSnapshot(doc(db, "characters", id), (snap) => {
            if(!snap.exists()) return;
            const d = snap.data();
            document.getElementById('char-name').innerText = d.Nome;
            document.getElementById('char-desc').innerText = `${d.Classe || '?'} | ${d.Origem || '?'}`;

            const inputs = ['pv','pv-max','pe','pe-max','xp','gold','for','agi','man','int','vig','def-eq'];
            const dbKeys = ['PV','PV_Max','PE','PE_Max','XP','Zeuro','For칞a','Agilidade','Mana','Intelecto','Vigor','Defesa_Equip'];
            
            inputs.forEach((id, i) => {
                const el = document.getElementById(`inp-${id}`);
                if(el) el.value = d[dbKeys[i]] || 0;
            });
            renderList('container-inv', d.itens || [], 'itens');
            renderList('container-skill', d.pericias || [], 'pericias');
        });
    }

    // === 5. OUTRAS FUN칂칏ES (Miss칚o, Combate, Listas) ===
    window.updateMission = async () => {
        await updateDoc(doc(db, "campaign_settings", "global"), {
            missao_titulo: document.getElementById('gm-mission-title').value,
            missao_desc: document.getElementById('gm-mission-desc').value
        });
        alert("Miss칚o atualizada!");
    };

    window.spawnMonster = async () => {
        const name = document.getElementById('mob-name').value;
        if(!name) return alert("Nome necess치rio");
        await addDoc(collection(db, "active_encounters"), {
            Nome: name,
            PV: parseInt(document.getElementById('mob-hp').value),
            PV_Max: parseInt(document.getElementById('mob-hp').value),
            Imagem: document.getElementById('mob-img').value
        });
        alert("Inimigo adicionado ao Combate!");
    };
    
    window.clearMonsters = async () => {
        if(!confirm("Limpar tracker de combate?")) return;
        const s = await getDocs(collection(db, "active_encounters"));
        s.forEach(d => deleteDoc(d.ref));
    };

    window.saveCharacter = async () => {
        if(!currentCharId) return;
        const d = {
            PV: parseInt(document.getElementById('inp-pv').value),
            PV_Max: parseInt(document.getElementById('inp-pv-max').value),
            PE: parseInt(document.getElementById('inp-pe').value),
            PE_Max: parseInt(document.getElementById('inp-pe-max').value),
            XP: parseInt(document.getElementById('inp-xp').value),
            Zeuro: parseInt(document.getElementById('inp-gold').value),
            For칞a: parseInt(document.getElementById('inp-for').value),
            Agilidade: parseInt(document.getElementById('inp-agi').value),
            Mana: parseInt(document.getElementById('inp-man').value),
            Intelecto: parseInt(document.getElementById('inp-int').value),
            Vigor: parseInt(document.getElementById('inp-vig').value),
            Defesa_Equip: parseInt(document.getElementById('inp-def-eq').value),
        };
        await updateDoc(doc(db, "characters", currentCharId), d);
        alert("Salvo!");
    };

    window.addEntryToChar = async (field, selId) => {
        const v = document.getElementById(selId).value;
        if(currentCharId && v) await updateDoc(doc(db, "characters", currentCharId), { [field]: arrayUnion(v) });
    };
    window.removeEntry = async (field, id) => {
        if(confirm("Remover?")) await updateDoc(doc(db, "characters", currentCharId), { [field]: arrayRemove(id) });
    };

    async function refreshGlobalData() {
        const load = async (c, t) => {
            const el = document.getElementById(t); el.innerHTML = "";
            const s = await getDocs(collection(db, c));
            s.forEach(d => {
                globalNameCache[d.id] = d.data().Nome;
                el.innerHTML += `<option value="${d.id}">${d.data().Nome}</option>`;
            });
        };
        await load('items', 'list-global-inv');
        await load('skills', 'list-global-skill');
    }

    function renderList(cid, ids, field) {
        const div = document.getElementById(cid); div.innerHTML = "";
        ids.forEach(id => {
            div.innerHTML += `<div class="item-row"><span>${globalNameCache[id]||id}</span><button class="danger btn-mini" onclick="window.removeEntry('${field}','${id}')">X</button></div>`;
        });
    }
</script>
</body>
</html>
