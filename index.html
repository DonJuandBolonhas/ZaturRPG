<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zatur - Grim√≥rio do Mestre</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=MedievalSharp&family=Lora:wght@400;700&display=swap');
        
        :root {
            --gold: #d4af37; --gold-dark: #8a7018; 
            --bg: #0b0704; --panel: #16100a; 
            --border: #4b2e0e; --danger: #5a1515; --success: #1e4215;
            --text: #cbbfa3;
        }

        body {
            font-family: 'MedievalSharp', cursive; background: var(--bg); color: var(--text); margin: 0;
            display: grid; grid-template-columns: 320px 1fr; height: 100vh; overflow: hidden;
        }

        /* BARRA LATERAL */
        aside {
            background: var(--panel); border-right: 3px solid var(--gold); padding: 15px;
            display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
            box-shadow: 5px 0 15px black; z-index: 10;
        }

        h1, h2, h3 { font-family: 'Cinzel'; color: var(--gold); margin: 0 0 10px 0; text-shadow: 1px 1px 2px black; }
        h1 { text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.8rem; }

        .control-group { background: rgba(0,0,0,0.4); padding: 15px; border: 1px solid var(--border); border-radius: 6px; }
        .control-group label { display: block; font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        
        input, select, textarea {
            width: 100%; padding: 8px; background: #000; border: 1px solid #444; color: var(--gold);
            font-family: 'Lora'; margin-bottom: 8px; box-sizing: border-box; border-radius: 4px;
        }
        input:focus, select:focus { outline: 1px solid var(--gold); border-color: var(--gold); }

        button {
            width: 100%; padding: 10px; background: linear-gradient(to bottom, #3a220a, #1a0f06); 
            color: var(--gold); border: 1px solid var(--gold-dark); cursor: pointer; 
            font-family: 'Cinzel'; font-weight: bold; transition: 0.2s; margin-top: 5px;
        }
        button:hover { background: var(--gold); color: #000; }
        button.danger { background: var(--danger); border-color: #ff4444; color: #ffcccc; }
        button.danger:hover { background: #ff0000; color: white; }

        /* √ÅREA PRINCIPAL */
        main { 
            padding: 30px; overflow-y: auto; 
            background-image: url('https://www.transparenttextures.com/patterns/black-linen.png');
            position: relative;
        }

        .empty-state {
            text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            opacity: 0.3; pointer-events: none;
        }

        #editor-panel { display: none; max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }
        
        .char-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 3px double var(--gold); padding-bottom: 10px; margin-bottom: 20px;
        }

        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .card { 
            background: rgba(22, 16, 10, 0.9); border: 1px solid var(--border); padding: 15px; 
            border-radius: 6px; position: relative;
        }
        .card h3 { border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 1rem; }

        .vitals-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .vital-box { text-align: center; background: #000; padding: 10px; border: 1px solid #333; }
        .vital-box label { color: var(--gold); font-size: 0.8rem; display: block; }
        .vital-box input { text-align: center; font-size: 1.5rem; border: none; background: transparent; color: white; font-family: 'MedievalSharp'; }

        .item-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px; border-bottom: 1px solid #333; font-size: 0.9rem; 
        }
        .item-row:hover { background: rgba(255,255,255,0.05); }
        .btn-mini { width: auto; padding: 2px 8px; margin: 0; font-size: 0.8rem; }
    </style>
</head>
<body>

<aside>
    <div>
        <h1>ZATUR RPG</h1>
        <div style="text-align:center; font-size:0.8rem; color:#666;">PAINEL DE CONTROLE</div>
    </div>

    <div class="control-group">
        <h2>üë§ Her√≥i Ativo</h2>
        <select id="player-select">
            <option value="">-- Selecione --</option>
        </select>
        <button id="btn-token-add">üìç Invocar Token no Mapa</button>
    </div>

    <div class="control-group">
        <h2>‚öíÔ∏è Forjar</h2>
        <label>O que voc√™ vai criar?</label>
        <select id="new-type">
            <option value="items">Item (Equipamento/Consum√≠vel)</option>
            <option value="skills">Per√≠cia (Habilidade/Magia)</option>
        </select>

        <label>Nome</label>
        <input type="text" id="new-item-name" placeholder="Ex: Espada Longa">
        
        <label>Descri√ß√£o</label>
        <textarea id="new-item-desc" rows="2" placeholder="Efeito ou detalhes..."></textarea>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div><label>Pre√ßo ($)</label><input type="number" id="new-item-price" value="0"></div>
            <div><label>√çcone (URL)</label><input type="text" id="new-item-img"></div>
        </div>
        
        <button id="btn-create-entry" style="border-color:var(--success); color:#cfc;">Salvar no Banco</button>
    </div>

    <div class="control-group">
        <h2>üåç Cen√°rio Global</h2>
        <label>URL do Mapa</label>
        <input type="text" id="global-map" placeholder="http://...">
        
        <label>URL da M√∫sica</label>
        <input type="text" id="global-music" placeholder="http://...">
        
        <button id="btn-update-world">Atualizar Tela dos Jogadores</button>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <button class="danger" onclick="clearTokens()">Limpar Mapa</button>
            <button onclick="resetPositions()">Reset Posi√ß√µes</button>
        </div>
    </div>
</aside>

<main>
    <div class="empty-state" id="empty-msg">
        <h1>Selecione um personagem<br>para come√ßar a editar</h1>
    </div>

    <div id="editor-panel">
        <div class="char-header">
            <div>
                <h1 id="char-name" style="text-align:left; border:none; padding:0; font-size:2.5rem">-</h1>
                <span id="char-desc" style="color:#888;">Classe | Origem</span>
            </div>
            <button onclick="saveCharacter()" style="width:auto; padding: 10px 30px; background:var(--gold); color:black;">üíæ SALVAR ALTERA√á√ïES</button>
        </div>

        <div class="grid-dashboard">
            <div class="card">
                <h3>‚ù§Ô∏è Vitais & Recursos</h3>
                <div class="vitals-grid">
                    <div class="vital-box">
                        <label>VIDA ATUAL</label>
                        <input type="number" id="inp-pv">
                    </div>
                    <div class="vital-box">
                        <label>VIDA M√ÅX</label>
                        <input type="number" id="inp-pv-max">
                    </div>
                    <div class="vital-box">
                        <label>MANA ATUAL</label>
                        <input type="number" id="inp-pe">
                    </div>
                    <div class="vital-box">
                        <label>MANA M√ÅX</label>
                        <input type="number" id="inp-pe-max">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>XP</label><input type="number" id="inp-xp"></div>
                    <div><label>Zeuros ($)</label><input type="number" id="inp-gold"></div>
                </div>
            </div>

            <div class="card">
                <h3>üìä Atributos Base</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>FOR√áA</label><input type="number" id="inp-for"></div>
                    <div><label>AGILIDADE</label><input type="number" id="inp-agi"></div>
                    <div><label>MANA (Attr)</label><input type="number" id="inp-man"></div>
                    <div><label>INTELECTO</label><input type="number" id="inp-int"></div>
                    <div><label>VIGOR</label><input type="number" id="inp-vig"></div>
                    <div><label>DEFESA EQ.</label><input type="number" id="inp-def-eq"></div>
                </div>
            </div>

            <div class="card">
                <h3>üéí Invent√°rio (Items)</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="list-global-inv"></select>
                    <button class="btn-mini" onclick="addEntryToChar('itens', 'list-global-inv')">+</button>
                </div>
                <div id="container-inv" style="max-height:200px; overflow-y:auto;"></div>
            </div>

            <div class="card">
                <h3>üìú Per√≠cias (Skills)</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="list-global-skill"></select>
                    <button class="btn-mini" onclick="addEntryToChar('pericias', 'list-global-skill')">+</button>
                </div>
                <div id="container-skill" style="max-height:200px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, getDocs, addDoc, arrayUnion, arrayRemove, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgYVod9B99WIc_QysFx73htOf9O8XtuE8",
        authDomain: "zatur-rpg.firebaseapp.com",
        projectId: "zatur-rpg",
        storageBucket: "zatur-rpg.firebasestorage.app",
        messagingSenderId: "797058283992",
        appId: "1:797058283992:web:7132e71691a225c1255aad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentCharId = null;
    let globalNameCache = {}; // Cache para nomes (items E skills)

    // INICIALIZA√á√ÉO
    async function init() {
        // 1. Carregar lista de Personagens
        const charsSnap = await getDocs(collection(db, "characters"));
        const select = document.getElementById('player-select');
        charsSnap.forEach(d => {
            select.innerHTML += `<option value="${d.id}">${d.data().Nome}</option>`;
        });

        // 2. Carregar Itens e Skills
        refreshGlobalData();
    }
    init();

    async function refreshGlobalData() {
        globalNameCache = {};
        
        // Carregar Items -> Popular Select Inv
        const invSel = document.getElementById('list-global-inv');
        invSel.innerHTML = "";
        const itemSnap = await getDocs(collection(db, "items"));
        itemSnap.forEach(d => {
            const data = d.data();
            globalNameCache[d.id] = data.Nome;
            invSel.innerHTML += `<option value="${d.id}">${data.Nome}</option>`;
        });

        // Carregar Skills -> Popular Select Skill
        const skillSel = document.getElementById('list-global-skill');
        skillSel.innerHTML = "";
        const skillSnap = await getDocs(collection(db, "skills"));
        skillSnap.forEach(d => {
            const data = d.data();
            globalNameCache[d.id] = data.Nome;
            skillSel.innerHTML += `<option value="${d.id}">${data.Nome}</option>`;
        });
    }

    // SELECIONAR JOGADOR
    document.getElementById('player-select').onchange = (e) => {
        currentCharId = e.target.value;
        if(currentCharId) {
            document.getElementById('empty-msg').style.display = 'none';
            document.getElementById('editor-panel').style.display = 'block';
            subscribeToChar(currentCharId);
        } else {
            document.getElementById('empty-msg').style.display = 'block';
            document.getElementById('editor-panel').style.display = 'none';
        }
    };

    // ESCUTAR MUDAN√áAS NA FICHA
    function subscribeToChar(id) {
        onSnapshot(doc(db, "characters", id), (snap) => {
            if(!snap.exists()) return;
            const d = snap.data();

            document.getElementById('char-name').innerText = d.Nome;
            document.getElementById('char-desc').innerText = `${d.Classe || '?'} | ${d.Origem || '?'}`;

            // Preencher Inputs
            const fields = ['pv','pv-max','pe','pe-max','xp','gold','for','agi','man','int','vig','def-eq'];
            const dbFields = ['PV','PV_Max','PE','PE_Max','XP','Zeuro','For√ßa','Agilidade','Mana','Intelecto','Vigor','Defesa_Equip'];
            
            fields.forEach((fid, i) => {
                const el = document.getElementById(`inp-${fid}`);
                if(el) el.value = d[dbFields[i]] || 0;
            });

            // Renderizar Listas (usando o campo correto do BD)
            renderList('container-inv', d.itens || [], 'itens');
            renderList('container-skill', d.pericias || [], 'pericias');
        });
    }

    function renderList(containerId, ids, fieldName) {
        const div = document.getElementById(containerId);
        div.innerHTML = "";
        ids.forEach(id => {
            const nome = globalNameCache[id] || id; 
            div.innerHTML += `
                <div class="item-row">
                    <span>${nome}</span>
                    <button class="danger btn-mini" onclick="window.removeEntry('${fieldName}', '${id}')">X</button>
                </div>`;
        });
    }

    // SALVAR FICHA MANUALMENTE
    window.saveCharacter = async () => {
        if(!currentCharId) return;
        const data = {
            PV: parseInt(document.getElementById('inp-pv').value),
            PV_Max: parseInt(document.getElementById('inp-pv-max').value),
            PE: parseInt(document.getElementById('inp-pe').value),
            PE_Max: parseInt(document.getElementById('inp-pe-max').value),
            XP: parseInt(document.getElementById('inp-xp').value),
            Zeuro: parseInt(document.getElementById('inp-gold').value),
            For√ßa: parseInt(document.getElementById('inp-for').value),
            Agilidade: parseInt(document.getElementById('inp-agi').value),
            Mana: parseInt(document.getElementById('inp-man').value),
            Intelecto: parseInt(document.getElementById('inp-int').value),
            Vigor: parseInt(document.getElementById('inp-vig').value),
            Defesa_Equip: parseInt(document.getElementById('inp-def-eq').value),
        };
        await updateDoc(doc(db, "characters", currentCharId), data);
        alert("Ficha salva!");
    };

    // ADICIONAR / REMOVER DA LISTA DO PERSONAGEM
    window.addEntryToChar = async (field, selectId) => {
        const itemId = document.getElementById(selectId).value;
        if(!currentCharId || !itemId) return;
        await updateDoc(doc(db, "characters", currentCharId), {
            [field]: arrayUnion(itemId)
        });
    };

    window.removeEntry = async (field, itemId) => {
        if(confirm("Remover da ficha do jogador?")) {
            await updateDoc(doc(db, "characters", currentCharId), {
                [field]: arrayRemove(itemId)
            });
        }
    };

    // CRIA√á√ÉO DE ITENS OU SKILLS (GLOBAL)
    document.getElementById('btn-create-entry').onclick = async () => {
        const collectionName = document.getElementById('new-type').value; // 'items' ou 'skills'
        const nome = document.getElementById('new-item-name').value;
        
        if(!nome) return alert("Nome obrigat√≥rio");
        
        await addDoc(collection(db, collectionName), {
            Nome: nome,
            Descricao: document.getElementById('new-item-desc').value,
            Preco: parseInt(document.getElementById('new-item-price').value),
            Imagem: document.getElementById('new-item-img').value
        });
        
        alert(`Criado com sucesso em ${collectionName}!`);
        
        // Limpar campos
        document.getElementById('new-item-name').value = "";
        document.getElementById('new-item-desc').value = "";
        
        refreshGlobalData(); // Atualizar selects
    };

    // CONTROLE DE MUNDO
    document.getElementById('btn-update-world').onclick = async () => {
        await setDoc(doc(db, "campaign_settings", "global"), {
            mapa_url: document.getElementById('global-map').value,
            musica_url: document.getElementById('global-music').value
        }, { merge: true });
        alert("Mundo sincronizado!");
    };

    document.getElementById('btn-token-add').onclick = async () => {
        if(!currentCharId) return alert("Selecione um her√≥i");
        const nome = document.getElementById('char-name').innerText;
        await updateDoc(doc(db, "campaign_settings", "global"), {
            [`posicoes.${currentCharId}`]: { x: 50, y: 50, nome: nome }
        });
    };

    window.clearTokens = async () => {
        if(confirm("Remover todos os tokens?")) {
            await updateDoc(doc(db, "campaign_settings", "global"), { posicoes: {} });
        }
    };
    
    window.resetPositions = async () => {
        const snap = await getDoc(doc(db, "campaign_settings", "global"));
        let pos = snap.data().posicoes || {};
        for(let k in pos) { pos[k].x = 50; pos[k].y = 50; }
        await updateDoc(doc(db, "campaign_settings", "global"), { posicoes: pos });
    };

</script>
</body>
</html>
