<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zatur - Mesa Virtual</title>
    <style>
        /* --- FONTES & VARI√ÅVEIS --- */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=MedievalSharp&family=Roboto:wght@400;500;700&display=swap');
        
        :root {
            --gold: #d4af37; 
            --gold-dim: #8a7018;
            --panel-bg: rgba(18, 14, 10, 0.95);
            --danger: #b91c1c;
            --mana: #1e4d8c;
            --text-main: #e5e5e5;
        }

        /* --- GERAL --- */
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'MedievalSharp', cursive; color: var(--text-main); user-select: none; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; outline: none; }

        /* SCROLLBAR CUSTOMIZADA */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 3px; }

        /* --- UI: START SCREEN --- */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.92); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); text-align: center;
        }
        .title-anim { animation: pulseGold 3s infinite; }
        @keyframes pulseGold { 0% { text-shadow: 0 0 20px #8a7018; } 50% { text-shadow: 0 0 40px #d4af37; } 100% { text-shadow: 0 0 20px #8a7018; } }
        
        #btn-enter {
            padding: 15px 60px; font-size: 1.5rem; background: transparent; color: var(--gold);
            border: 2px solid var(--gold); font-family: 'Cinzel'; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 3px; transition: 0.3s; margin-top: 30px;
        }
        #btn-enter:hover { background: var(--gold); color: #000; box-shadow: 0 0 30px var(--gold); transform: scale(1.05); }

        /* --- UI: MAPA & CONTROLES --- */
        #map-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #111; touch-action: none; }
        
        #bottom-controls {
            position: absolute; bottom: 20px; left: 20px; z-index: 5;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .control-grp { 
            display: flex; gap: 8px; background: rgba(0,0,0,0.7); padding: 8px; 
            border-radius: 8px; border: 1px solid #444; pointer-events: auto; backdrop-filter: blur(4px);
        }
        .map-btn { 
            width: 40px; height: 40px; cursor: pointer; background: #222; color: var(--gold); 
            border: 1px solid #555; border-radius: 4px; font-size: 1.4rem; 
            display:flex; align-items:center; justify-content:center; transition: 0.2s;
        }
        .map-btn:active { transform: scale(0.9); background: var(--gold); color: black; }

        /* --- UI: HUD LATERAL --- */
        #ui-layer {
            position: absolute; top: 0; right: 0; height: 100vh; width: 380px;
            background: var(--panel-bg); border-left: 2px solid var(--gold-dim);
            z-index: 100; display: flex; flex-direction: column;
            box-shadow: -5px 0 30px rgba(0,0,0,0.8);
            transition: transform 0.3s ease-in-out;
        }
        
        /* Mobile Toggle */
        #mobile-hud-toggle {
            display: none; position: absolute; top: 15px; right: 15px; z-index: 101;
            width: 50px; height: 50px; background: rgba(0,0,0,0.8); border: 2px solid var(--gold);
            border-radius: 50%; color: var(--gold); font-size: 1.5rem;
            align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 15px black;
        }

        .char-header { padding: 20px; background: linear-gradient(180deg, rgba(20,15,10,1) 0%, rgba(10,5,0,0) 100%); }
        .char-name { margin: 0; color: var(--gold); font-family: 'Cinzel'; font-size: 1.5rem; text-transform: uppercase; }
        
        .bars-container { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        .bar-wrap { position: relative; height: 22px; background: #111; border: 1px solid #444; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .bar-txt { position: absolute; width: 100%; text-align: center; top: 2px; font-size: 0.75rem; font-family: 'Roboto'; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px black; z-index: 2; }

        /* TABS */
        .nav-tabs { display: flex; background: rgba(0,0,0,0.5); }
        .nav-btn {
            flex: 1; padding: 15px; background: none; border: none; color: #666;
            font-family: 'Cinzel'; font-weight: bold; cursor: pointer; 
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .nav-btn.active { color: var(--gold); border-bottom-color: var(--gold); background: rgba(212,175,55,0.05); }

        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; flex-direction: column; gap: 15px; }
        .tab-content.active { display: flex; }

        /* LISTAS & CARDS */
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .attr-card { 
            background: rgba(255,255,255,0.03); border: 1px solid #333; padding: 10px; 
            text-align: center; border-radius: 6px; cursor: pointer; 
        }
        .attr-card:active { transform: scale(0.95); background: rgba(212,175,55,0.2); }

        .list-item { background: rgba(0,0,0,0.4); border: 1px solid #333; border-radius: 4px; margin-bottom: 5px; }
        .list-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .list-body { padding: 10px; font-family: 'Roboto'; font-size: 0.85rem; color: #aaa; background: rgba(0,0,0,0.6); display: none; border-top: 1px solid #333; }
        .list-body.open { display: block; }

        /* COMBATE & CHAT */
        .combat-card { 
            background: linear-gradient(90deg, #2a0a0a, #150505); border: 1px solid #522; 
            padding: 10px; border-radius: 6px; display: flex; flex-direction: column; gap: 10px; 
        }
        .btn-attack-main { width: 100%; padding: 8px; background: #800; color: white; border: 1px solid #a00; font-family: 'Cinzel'; cursor: pointer; }
        
        #log-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; font-family: 'Roboto'; padding-bottom: 10px; }
        .msg { padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid #555; background: rgba(255,255,255,0.03); }
        .msg-roll { border-left-color: var(--gold); background: rgba(50,40,10,0.3); }
        .crit { color: #ffd700; text-shadow: 0 0 5px #ffd700; }
        .fumble { color: #ff5555; }

        .chat-input-box { display: flex; gap: 5px; padding-top: 10px; border-top: 1px solid #333; }
        .inp-chat { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 4px; }
        .btn-send { width: 50px; background: var(--gold); border: none; border-radius: 4px; font-size: 1.2rem; cursor: pointer; }

        /* PAINEL GM */
        #gm-btn { position: absolute; top: 15px; left: 15px; z-index: 50; width: 40px; height: 40px; background: #222; border: 1px solid var(--gold); color: var(--gold); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        #gm-panel { position: absolute; top: 60px; left: 15px; background: rgba(10,10,10,0.95); padding: 20px; width: 300px; border: 1px solid var(--gold); border-radius: 8px; display: none; z-index: 50; max-height: 80vh; overflow-y: auto; }
        .gm-inp { width: 100%; padding: 8px; background: #000; color: white; border: 1px solid #444; margin-bottom: 10px; }

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: #111; border: 2px solid var(--gold); padding: 30px; width: 90%; max-width: 400px; text-align: center; border-radius: 10px; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        .btn-action { width: 100%; padding: 12px; margin-top: 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; background: var(--gold); color: black; font-family: 'Cinzel'; }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            #mobile-hud-toggle { display: flex; }
            #ui-layer { width: 100%; transform: translateX(100%); }
            #ui-layer.open { transform: translateX(0); }
            
            #mission-bar { width: 95%; top: 70px; padding: 10px; font-size: 0.9rem; }
            .mission-text { font-size: 1.1rem; }
            
            .modal-box { padding: 20px; }
            #start-overlay h1 { font-size: 3rem !important; }
        }
    </style>
</head>
<body>

<div id="start-overlay">
    <h1 class="title-anim" style="font-family:'Cinzel'; font-size:5rem; color:var(--gold); margin:0;">ZATUR</h1>
    <p style="color:#aaa; font-family:'Roboto'; letter-spacing:2px;">Mesa de RPG Virtual v3.5</p>
    <button id="btn-enter" onclick="enterGame()">Entrar na Sess√£o</button>
</div>

<div id="mobile-hud-toggle" onclick="toggleMobileHUD()">üìú</div>
<div id="mission-bar" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20; background: linear-gradient(90deg, transparent, rgba(0,0,0,0.8), transparent); padding: 10px 40px; border-bottom: 2px solid var(--gold-dim); text-align: center; pointer-events: none; width: 60%; transition: 0.3s;">
    <span style="color:var(--gold); font-family:'Cinzel'; font-size:0.8rem; letter-spacing:2px; text-transform:uppercase;">üìú Objetivo Atual</span>
    <div id="mission-display" class="mission-text" style="color:white; font-size:1.3rem; text-shadow:0 2px 4px black; margin-top:5px;">Aguardando o Mestre...</div>
</div>

<audio id="bg-audio" loop></audio>

<div id="map-layer">
    <canvas id="gameCanvas"></canvas>
    <div id="bottom-controls">
        <div class="control-grp">
            <button class="map-btn" onclick="zoomMap(0.1)">+</button>
            <button class="map-btn" onclick="zoomMap(-0.1)">-</button>
            <button class="map-btn" onclick="resetView()">‚ü≤</button>
        </div>
        <div class="control-grp">
            <button class="map-btn" onclick="toggleMute()" id="mute-icon" style="font-size:1rem">üîä</button>
            <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="setVolume(this.value)" style="width:80px; accent-color:var(--gold);">
        </div>
    </div>
</div>

<div id="gm-btn" onclick="toggleGM()">‚öôÔ∏è</div>
<div id="gm-panel">
    <h3 style="color:var(--gold); font-family:'Cinzel'; margin-top:0;">Painel do Mestre</h3>
    
    <label style="color:#aaa; font-size:0.8rem;">Mapa (URL Imagem)</label>
    <input type="text" id="gm-map" class="gm-inp" placeholder="https://...">
    
    <label style="color:#aaa; font-size:0.8rem;">M√∫sica (URL MP3)</label>
    <input type="text" id="gm-music" class="gm-inp" placeholder="https://...">
    
    <label style="color:#aaa; font-size:0.8rem;">Miss√£o / Texto</label>
    <input type="text" id="gm-mission-input" class="gm-inp" placeholder="Objetivo atual...">
    
    <button class="btn-action" onclick="syncWorld()">Sincronizar Mundo</button>
    
    <hr style="border-color:#333; margin:15px 0;">
    
    <label style="color:#aaa; font-size:0.8rem;">Novo Token (Nome)</label>
    <input type="text" id="tk-name" class="gm-inp" placeholder="Goblin, Heroi...">
    
    <label style="color:#aaa; font-size:0.8rem;">Imagem do Token (URL)</label>
    <input type="text" id="tk-img" class="gm-inp" placeholder="https://...">
    
    <button class="btn-action" style="background:#333; color:white; border:1px solid #555;" onclick="activateTokenPlacement()">üìç Adicionar no Mapa</button>
</div>

<aside id="ui-layer">
    <div class="char-header">
        <h2 id="hud-name" class="char-name">Carregando...</h2>
        <div id="hud-details" style="color:#888; font-size:0.85rem; font-style:italic;">Classe, Ra√ßa Nvl 1</div>
        
        <div class="bars-container">
            <div class="bar-wrap">
                <span id="txt-hp" class="bar-txt">PV: 0/0</span>
                <div id="bar-hp" class="bar-fill" style="background:var(--danger); width:0%"></div>
            </div>
            <div class="bar-wrap">
                <span id="txt-mp" class="bar-txt">PM: 0/0</span>
                <div id="bar-mp" class="bar-fill" style="background:var(--mana); width:0%"></div>
            </div>
        </div>
    </div>

    <nav class="nav-tabs">
        <button class="nav-btn active" onclick="setTab('tab-sheet', this)">Ficha</button>
        <button class="nav-btn" onclick="setTab('tab-combat', this)" style="color:#ffaaaa">Combate</button>
        <button class="nav-btn" onclick="setTab('tab-chat', this)">Chat</button>
    </nav>

    <div id="tab-sheet" class="tab-content active">
        <div style="color:var(--gold); border-bottom:1px solid #333; font-family:'Cinzel'; margin-bottom:10px;">Atributos</div>
        <div id="grid-attrs" class="attr-grid"></div>

        <div style="color:var(--gold); border-bottom:1px solid #333; font-family:'Cinzel'; margin:20px 0 10px;">Per√≠cias & Habilidades</div>
        <div id="list-skills"></div>

        <div style="color:var(--gold); border-bottom:1px solid #333; font-family:'Cinzel'; margin:20px 0 10px;">Invent√°rio</div>
        <div id="list-inventory"></div>
    </div>

    <div id="tab-combat" class="tab-content">
        <div style="text-align:center; color:#ff5555; font-family:'Cinzel'; margin-bottom:10px;">Inimigos Ativos</div>
        <div id="list-enemies">
            <p style="text-align:center; color:#666; font-size:0.9rem; margin-top:20px;">Nenhum inimigo √† vista.</p>
        </div>
    </div>

    <div id="tab-chat" class="tab-content" style="height:100%; padding-bottom:0;">
        <div id="log-container"></div>
        <div class="chat-input-box" style="margin-bottom:15px;">
            <input type="text" id="inp-msg" class="inp-chat" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="btn-send" onclick="sendChat()">‚û§</button>
        </div>
    </div>
</aside>

<div id="modal-attack" class="modal-overlay">
    <div class="modal-box">
        <h3 style="color:var(--danger); margin:0; font-family:'Cinzel'">REALIZAR ATAQUE</h3>
        <p id="atk-target-label" style="color:#888; font-size:0.9rem; margin-bottom:20px">Alvo: ...</p>
        
        <select id="atk-option" class="gm-inp" style="padding:12px; font-size:1rem; border-color:var(--gold);"></select>
        
        <div style="display:flex; justify-content:center; gap:20px; margin:20px 0;">
            <label><input type="radio" name="atk-mod" value="0" checked> Normal</label>
            <label style="color:var(--gold)"><input type="radio" name="atk-mod" value="5"> Vantagem</label>
            <label style="color:var(--danger)"><input type="radio" name="atk-mod" value="-5"> Desv.</label>
        </div>

        <button class="btn-action" onclick="confirmAttack()">ROLAR DADO</button>
        <button style="background:none; border:none; color:#777; margin-top:15px; text-decoration:underline; cursor:pointer;" onclick="closeModal('modal-attack')">Cancelar</button>
    </div>
</div>

<div id="modal-result" class="modal-overlay">
    <div class="modal-box">
        <h3 style="color:#aaa; margin:0; font-size:1rem">RESULTADO</h3>
        <div id="res-val" style="font-size:5rem; font-family:'Cinzel'; margin:10px 0; color:white;">0</div>
        <div id="res-msg" style="color:#ccc; font-size:0.9rem; margin-bottom:20px">Detalhes...</div>
        
        <button id="btn-dmg" class="btn-action" style="background:var(--danger); color:white; border:1px solid #f55;" onclick="applyDamageFlow()">üí• APLICAR DANO</button>
        <button style="background:none; border:none; color:#777; margin-top:15px; text-decoration:underline; cursor:pointer;" onclick="closeModal('modal-result')">Fechar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, getDoc, collection, updateDoc, setDoc, addDoc, query, orderBy, limit, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURA√á√ÉO ---
    const firebaseConfig = {
        apiKey: "AIzaSyAgYVod9B99WIc_QysFx73htOf9O8XtuE8",
        authDomain: "zatur-rpg.firebaseapp.com",
        projectId: "zatur-rpg",
        storageBucket: "zatur-rpg.firebasestorage.app",
        messagingSenderId: "797058283992",
        appId: "1:797058283992:web:7132e71691a225c1255aad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const charId = new URLSearchParams(window.location.search).get("id");

    let playerData = {};
    let combatOptions = []; 
    let currentTargetId = null;
    let audio = document.getElementById('bg-audio');
    let hasInteracted = false;

    // --- SISTEMA CORE ---
    window.enterGame = () => {
        document.getElementById('start-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 500);
        hasInteracted = true;
        if(audio.src) audio.play().catch(e => console.log("Audio play failed", e));
        initSystem();
    };

    function initSystem() {
        if(charId) {
            onSnapshot(doc(db, "characters", charId), (snap) => {
                if(!snap.exists()) return;
                playerData = snap.data();
                updateHUD();
                loadAssets();
            });
        }

        // Monstros Ativos
        onSnapshot(collection(db, "active_encounters"), (snap) => {
            const container = document.getElementById('list-enemies');
            container.innerHTML = "";
            if(snap.empty) {
                container.innerHTML = "<p style='text-align:center; color:#666'>Sem amea√ßas.</p>";
                return;
            }
            snap.forEach(d => {
                const en = d.data();
                const hpPercent = Math.max(0, Math.min(100, (en['Pontos de Vida Atual'] / en['Pontos de Vida Max']) * 100));
                let hpColor = hpPercent > 50 ? "#22c55e" : (hpPercent > 25 ? "#eab308" : "var(--danger)");
                
                container.innerHTML += `
                <div class="combat-card">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img src="${en.Imagem || 'https://via.placeholder.com/60'}" style="width:50px; height:50px; border-radius:4px; object-fit:cover; border:1px solid #555;">
                        <div style="flex:1;">
                            <div style="font-family:'Cinzel'; color:#ff9999;">${en.Nome}</div>
                            <div style="height:6px; background:#333; margin-top:5px; border-radius:2px;">
                                <div style="height:100%; width:${hpPercent}%; background:${hpColor}; border-radius:2px; transition:width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-attack-main" onclick="openAttackModal('${d.id}', '${en.Nome}')">‚öîÔ∏è ATACAR</button>
                </div>`;
            });
        });

        // Chat
        const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(30));
        onSnapshot(q, (snap) => {
            const container = document.getElementById('log-container');
            const msgs = [];
            snap.forEach(d => msgs.push(d.data()));
            msgs.reverse();
            container.innerHTML = "";
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.type === 'chat' ? '' : 'msg-roll'}`;
                if(m.type === 'chat') {
                    div.innerHTML = `<span style="color:var(--gold); font-weight:bold;">${m.charName}:</span> <span style="color:#ddd">${m.message}</span>`;
                } else {
                    let extraClass = m.isCrit ? "crit" : (m.isFumble ? "fumble" : "");
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold; color:#aaa;">${m.charName}</span>
                            <span class="${extraClass}" style="font-size:1.1rem; font-weight:bold;">${m.total}</span>
                        </div>
                        <div style="font-size:0.8rem; color:#888;">${m.actionName} <small>(${m.detail})</small></div>
                    `;
                }
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        });

        // Configura√ß√µes Globais
        onSnapshot(doc(db,"campaign_settings","global"), (s) => {
            if(!s.exists()) return;
            const data = s.data();
            
            // Miss√£o
            if(data.missao_atual) {
                document.getElementById('mission-display').innerText = data.missao_atual;
                document.getElementById('gm-mission-input').value = data.missao_atual;
            }

            // Mapa
            if(data.mapa_url && (!mapImg || mapImg.src !== data.mapa_url)) {
                mapImg = new Image(); 
                mapImg.crossOrigin = "anonymous";
                mapImg.src = data.mapa_url; 
                mapImg.onload = renderMap; 
                document.getElementById('gm-map').value = data.mapa_url;
            }
            
            // Audio
            if(data.musica_url && audio.src !== data.musica_url) {
                audio.src = data.musica_url;
                document.getElementById('gm-music').value = data.musica_url;
                if(hasInteracted) audio.play().catch(()=>{});
            }

            tokens = data.posicoes || {};
            renderMap();
        });
        
        initCanvas();
    }

    // --- INTERFACE ---
    window.toggleMobileHUD = () => {
        document.getElementById('ui-layer').classList.toggle('open');
    };

    function updateHUD() {
        document.getElementById('hud-name').innerText = playerData.Nome || "Heroi";
        document.getElementById('hud-details').innerText = `${playerData.Classe || '?'} - Nvl ${playerData.Nivel || 1}`;
        document.getElementById('bar-hp').style.width = ((playerData['Pontos de Vida Atual'] / playerData['Pontos de Vida Max']) * 100) + "%";
        document.getElementById('txt-hp').innerText = `${playerData['Pontos de Vida Atual']}/${playerData['Pontos de Vida Max']}`;
        document.getElementById('bar-mp').style.width = ((playerData['Pontos de Mana Atual'] / playerData['Pontos de Mana Max']) * 100) + "%";
        document.getElementById('txt-mp').innerText = `${playerData['Pontos de Mana Atual']}/${playerData['Pontos de Mana Max']}`;
        
        const grid = document.getElementById('grid-attrs');
        grid.innerHTML = "";
        ["For√ßa", "Agilidade", "Intelecto", "Vigor", "Mana"].forEach(a => {
            const val = playerData[a] || 0;
            grid.innerHTML += `<div class="attr-card" onclick="rollSimple('${a}', ${val})"><div style="font-size:0.7rem; color:#888; text-transform:uppercase;">${a.substring(0,3)}</div><div style="font-size:1.3rem; font-weight:bold; color:var(--gold);">${val}</div></div>`;
        });
    }

    async function loadAssets() {
        const skillsDiv = document.getElementById('list-skills');
        const invDiv = document.getElementById('list-inventory');
        skillsDiv.innerHTML = ""; invDiv.innerHTML = "";
        combatOptions = [];

        // Per√≠cias (Agora √© Array de IDs, buscamos na cole√ß√£o 'skills')
        // Se a estrutura antiga era string "Nome (+Bonus)", precisamos adaptar ou assumir IDs
        // O c√≥digo do mestre agora salva IDs.
        
        const loadList = async (listIds, collectionName, targetDiv, icon, type) => {
            if(!listIds || listIds.length === 0) return;
            for(let id of listIds) {
                // Tenta buscar no banco
                let data = null;
                try {
                    let snap = await getDoc(doc(db, collectionName, id));
                    if(snap.exists()) data = snap.data();
                } catch(e){}

                if(data) {
                    const sub = data.Dano ? `Dano: ${data.Dano}` : (data.Bonus ? `+${data.Bonus}` : "");
                    createListItem(targetDiv, icon, data.Nome, sub, () => rollSimple(data.Nome, data.Bonus||0), data.Descricao);
                    combatOptions.push({ name: data.Nome, type: type, bonus: data.Bonus||0, dmg: data.Dano });
                }
            }
        };

        await loadList(playerData.Pericias, 'skills', skillsDiv, 'üé≤', 'Per√≠cia');
        await loadList(playerData.Habilidades, 'abilities', skillsDiv, '‚ö°', 'Habilidade');
        await loadList(playerData.Itens, 'items', invDiv, '‚öîÔ∏è', 'Item');
        await loadList(playerData.Magias, 'spells', invDiv, 'üîÆ', 'Magia');
    }

    function createListItem(container, icon, title, subtitle, onClickRoll, description = null) {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
            <div class="list-header" onclick="toggleDetails(this)">
                <div>${icon} <strong style="color:#eee; margin-left:5px;">${title}</strong> <small style="color:#888;">${subtitle}</small></div>
                <button style="background:none; border:1px solid #555; border-radius:50%; width:24px; height:24px; color:var(--gold); cursor:pointer;" onclick="event.stopPropagation(); callRoll()">üé≤</button>
            </div>
            ${description ? `<div class="list-body">${description}</div>` : ''}
        `;
        div.querySelector('button').onclick = (e) => { e.stopPropagation(); onClickRoll(); };
        container.appendChild(div);
    }
    window.toggleDetails = (el) => { const b=el.nextElementSibling; if(b) b.classList.toggle('open'); }

    // --- COMBATE & DADOS ---
    window.openAttackModal = (enemyId, enemyName) => {
        currentTargetId = enemyId;
        document.getElementById('modal-attack').style.display = 'flex';
        document.getElementById('atk-target-label').innerText = `Alvo: ${enemyName}`;
        const sel = document.getElementById('atk-option');
        sel.innerHTML = `<option value="Ataque B√°sico">üëä Ataque B√°sico (For√ßa)</option>`;
        combatOptions.forEach(opt => sel.innerHTML += `<option value="${opt.name}">[${opt.type}] ${opt.name}</option>`);
    };

    window.confirmAttack = () => {
        const action = document.getElementById('atk-option').value;
        const mod = parseInt(document.querySelector('input[name="atk-mod"]:checked').value);
        let attrBonus = playerData.For√ßa || 0;
        const opt = combatOptions.find(o => o.name === action);
        if(opt) attrBonus = opt.type === 'Per√≠cia' ? opt.bonus : (opt.type === 'Magia' ? (playerData.Intelecto||0) : attrBonus);

        const d20 = Math.floor(Math.random()*20)+1;
        const total = d20 + mod + attrBonus;
        
        addDoc(collection(db, "logs"), {
            charName: playerData.Nome || "Mestre", actionName: action,
            total: total, detail: `[${d20}] + Bonus(${attrBonus}) + Mod(${mod})`,
            isCrit: d20===20, isFumble: d20===1, type: 'roll', timestamp: serverTimestamp()
        });

        document.getElementById('modal-attack').style.display = 'none';
        showResultModal(total, action, d20===20, d20===1, true);
    };

    window.rollSimple = (name, bonus) => {
        const d20 = Math.floor(Math.random()*20)+1;
        const total = d20 + bonus;
        addDoc(collection(db, "logs"), {
            charName: playerData.Nome || "Mestre", actionName: name, total: total,
            detail: `[${d20}] + ${bonus}`, isCrit: d20===20, isFumble: d20===1, type: 'roll', timestamp: serverTimestamp()
        });
        showResultModal(total, name, d20===20, d20===1, false);
    };

    function showResultModal(val, txt, crit, fumble, showDmg) {
        const m = document.getElementById('modal-result');
        const v = document.getElementById('res-val');
        v.innerText = val;
        v.style.color = crit ? "var(--gold)" : (fumble ? "#ff5555" : "white");
        document.getElementById('res-msg').innerText = txt + (crit?" (CR√çTICO!)":"") + (fumble?" (FALHA!)":"");
        document.getElementById('btn-dmg').style.display = showDmg ? 'block' : 'none';
        m.style.display = 'flex';
    }

    window.applyDamageFlow = async () => {
        if(!currentTargetId) return;
        const dmg = parseInt(prompt("Quanto de dano?", "0"));
        if(!isNaN(dmg) && dmg > 0) {
            const ref = doc(db, "active_encounters", currentTargetId);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                const novo = Math.max(0, snap.data()['Pontos de Vida Atual'] - dmg);
                await updateDoc(ref, { 'Pontos de Vida Atual': novo });
                addDoc(collection(db, "logs"), { charName: "SISTEMA", message: `${snap.data().Nome} sofreu ${dmg} de dano!`, type: 'chat', timestamp: serverTimestamp() });
            }
        }
        closeModal('modal-result');
    };

    window.sendChat = () => {
        const i = document.getElementById('inp-msg');
        if(i.value.trim()) addDoc(collection(db,"logs"),{charName:playerData.Nome || "Mestre",message:i.value,type:'chat',timestamp:serverTimestamp()});
        i.value="";
    };

    window.closeModal = (id) => document.getElementById(id).style.display='none';
    window.setTab = (id,b) => {
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
        document.getElementById(id).classList.add('active'); b.classList.add('active');
    };

    // === ENGINE DE MAPA ===
    let canvas, ctx, mapImg;
    let tokens = {}; // { id: {x, y, size, img, name} }
    let view = {x:0, y:0, zoom:1};
    let isMapDrag = false, isTokenDrag = false, dragTokenId = null, lastPos = {x:0,y:0};
    let placingToken = false;

    function initCanvas() {
        canvas = document.getElementById('gameCanvas'); 
        ctx = canvas.getContext('2d');
        resize();
        window.onresize = resize;

        canvas.onmousedown = e => {
            if(placingToken){ placeTokenClick(e); return; }

            const worldX = (e.clientX - view.x) / view.zoom;
            const worldY = (e.clientY - view.y) / view.zoom;

            let hitToken = null;
            const tokenKeys = Object.keys(tokens);
            for(let i = tokenKeys.length - 1; i >= 0; i--) {
                const id = tokenKeys[i];
                const t = tokens[id];
                const size = t.size || 50;
                if(Math.sqrt((worldX - t.x)**2 + (worldY - t.y)**2) <= size/2) {
                    hitToken = id; break; 
                }
            }

            if(hitToken) { isTokenDrag = true; dragTokenId = hitToken; } 
            else { isMapDrag = true; }
            lastPos = {x:e.clientX, y:e.clientY};
        };

        canvas.onmousemove = e => {
            if(isTokenDrag && dragTokenId) {
                const dx = (e.clientX - lastPos.x) / view.zoom;
                const dy = (e.clientY - lastPos.y) / view.zoom;
                tokens[dragTokenId].x += dx; tokens[dragTokenId].y += dy;
                renderMap();
            } else if(isMapDrag) {
                view.x += e.clientX - lastPos.x; view.y += e.clientY - lastPos.y;
                renderMap();
            }
            lastPos = {x:e.clientX, y:e.clientY};
        };

        canvas.onmouseup = async () => {
            if(isTokenDrag) {
                await updateDoc(doc(db,"campaign_settings","global"), { posicoes: tokens });
            }
            isMapDrag = false; isTokenDrag = false; dragTokenId = null;
        };
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; renderMap(); }

    function renderMap() {
        if(!ctx) return;
        ctx.fillStyle = "#080808"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.save(); ctx.translate(view.x, view.y); ctx.scale(view.zoom, view.zoom);
        
        if(mapImg) ctx.drawImage(mapImg, 0, 0);
        
        for(let id in tokens) {
            const t = tokens[id];
            const size = t.size || 50;
            ctx.save();
            ctx.beginPath(); ctx.arc(t.x, t.y, size/2, 0, Math.PI*2);
            ctx.fillStyle = "#222"; ctx.fill(); 
            ctx.strokeStyle = "gold"; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = "white"; ctx.font = "bold 14px Arial"; ctx.textAlign="center";
            ctx.fillText(t.name || "?", t.x, t.y - size/2 - 5);
            ctx.restore();
        }
        ctx.restore();
    }

    // --- GM TOOLS (S√≥ para quando logar sem ID, modo espectador/GM) ---
    window.toggleGM = () => document.getElementById('gm-panel').style.display = document.getElementById('gm-panel').style.display==='block'?'none':'block';
    window.syncWorld = async () => {
        await updateDoc(doc(db,"campaign_settings","global"), {
            mapa_url: document.getElementById('gm-map').value,
            musica_url: document.getElementById('gm-music').value,
            missao_atual: document.getElementById('gm-mission-input').value
        });
    };
    window.activateTokenPlacement = () => { placingToken = true; document.body.style.cursor = "crosshair"; };
    
    function placeTokenClick(e) {
        const wx = (e.clientX - view.x) / view.zoom;
        const wy = (e.clientY - view.y) / view.zoom;
        const id = "tk_"+Date.now();
        tokens[id] = { x:wx, y:wy, size:50, name: document.getElementById('tk-name').value||"Token", img: document.getElementById('tk-img').value };
        updateDoc(doc(db,"campaign_settings","global"), { posicoes: tokens });
        placingToken = false; document.body.style.cursor="default";
        renderMap();
    }

    // Zoom
    window.zoomMap = (z) => { view.zoom = Math.max(0.2, view.zoom+z); renderMap(); };
    window.resetView = () => { view = {x:0,y:0,zoom:1}; renderMap(); };
    window.toggleMute = () => { audio.muted = !audio.muted; document.getElementById('mute-icon').innerText = audio.muted?'üîá':'üîä'; };
    window.setVolume = (v) => audio.volume = v;

</script>
</body>
</html>
