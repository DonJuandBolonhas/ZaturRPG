<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zatur - Player V17</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* =========================================
           1. CORE & VARIABLES
           ========================================= */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600;700&display=swap');

        :root {
            --bg-body: #050505;
            --bg-surface: #121212;
            --bg-card: #1c1c1e;
            --bg-input: #2c2c2e;
            
            --gold: #cca43b;
            --gold-glow: rgba(204, 164, 59, 0.3);
            --danger: #ef4444;
            --mana: #3b82f6;
            
            --text-main: #f5f5f5;
            --text-muted: #a3a3a3;
            --border: #333;

            --header-h: 55px;
            --nav-h: 65px;
            --safe-area-bot: env(safe-area-inset-bottom, 0px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            position: fixed;
        }

        .font-brand { font-family: 'Cinzel', serif; letter-spacing: 0.5px; }
        .text-gold { color: var(--gold); }
        .text-red { color: var(--danger); }
        .text-blue { color: var(--mana); }
        .text-sm { font-size: 0.85rem; color: var(--text-muted); }

        /* =========================================
           2. LAYOUT SYSTEM
           ========================================= */
        .app-header {
            position: absolute; top: 0; left: 0; right: 0;
            height: var(--header-h);
            background: rgba(18, 18, 18, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 50;
        }
        .header-avatar { 
            width: 32px; height: 32px; border-radius: 50%; 
            background: #222; border: 1px solid var(--gold); 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; color: var(--gold); font-size: 0.8rem;
        }

        main {
            position: absolute;
            top: var(--header-h);
            bottom: calc(var(--nav-h) + var(--safe-area-bot));
            left: 0; right: 0;
            overflow: hidden; /* Control scroll per section */
        }

        /* View Section Handling */
        .view-section {
            display: none;
            width: 100%; height: 100%;
            overflow-y: auto; /* Default scroll */
            padding: 20px;
            padding-bottom: 40px;
            -webkit-overflow-scrolling: touch;
        }
        .view-section.active { display: block; animation: fadeIn 0.2s ease-out; }
        
        #chat.view-section { padding: 0; overflow: hidden; display: none; flex-direction: column; }
        #chat.view-section.active { display: flex; }
        
        #map.view-section { padding: 0; overflow: hidden; display: none; flex-direction: column; }
        #map.view-section.active { display: flex; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        .bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: calc(var(--nav-h) + var(--safe-area-bot));
            padding-bottom: var(--safe-area-bot);
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 50;
        }
        .nav-btn {
            flex: 1; height: 100%;
            background: none; border: none; color: #666;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; font-size: 0.7rem; font-weight: 600;
            cursor: pointer; transition: 0.2s;
        }
        .nav-btn i { font-size: 1.4rem; transition: 0.2s; }
        .nav-btn.active { color: var(--gold); }
        .nav-btn.active i { transform: translateY(-2px); text-shadow: 0 0 12px var(--gold-glow); }

        @media (min-width: 768px) {
            .app-header { display: none; }
            .bottom-nav {
                position: fixed; top: 0; left: 0; bottom: 0;
                width: 260px; height: 100%;
                flex-direction: column; justify-content: flex-start; padding-top: 40px;
                border-top: none; border-right: 1px solid var(--border);
            }
            .nav-btn { height: auto; width: 100%; padding: 15px 30px; flex-direction: row; gap: 15px; font-size: 1rem; justify-content: flex-start; }
            main { top: 0; left: 260px; bottom: 0; width: calc(100% - 260px); }
            .bottom-nav::before {
                content: "ZATUR"; font-family: 'Cinzel', serif; color: var(--gold);
                font-size: 2rem; font-weight: bold; margin-bottom: 40px; padding-left: 30px; display: block;
            }
        }

        /* =========================================
           3. UI COMPONENTS
           ========================================= */
        .panel {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px; margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .status-header { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-col { flex: 1; }
        .stat-meta { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700; margin-bottom: 6px; }
        .bar-track { height: 10px; background: #000; border-radius: 5px; overflow: hidden; border: 1px solid #333; }
        .bar-fill { height: 100%; border-radius: 5px; transition: width 0.4s ease; }
        .hp-fill { background: linear-gradient(90deg, #7f1d1d, #ef4444); }
        .mp-fill { background: linear-gradient(90deg, #1e3a8a, #3b82f6); }

        .attr-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .attr-card {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 8px; padding: 10px 0; text-align: center;
            cursor: pointer; transition: 0.1s;
        }
        .attr-card:active { transform: scale(0.95); background: #333; border-color: var(--gold); }
        .attr-label { font-size: 0.65rem; color: #888; font-weight: 700; }
        .attr-val { font-size: 1.2rem; font-weight: 700; color: #fff; font-family: 'Cinzel'; }

        .grid-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; }
        .grid-item {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 8px; aspect-ratio: 1/1; cursor: pointer;
            position: relative; overflow: hidden; transition: border-color 0.2s;
        }
        .grid-item:hover { border-color: var(--gold); }
        .grid-thumb { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .grid-name {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(0,0,0,0.85); color: #fff;
            font-size: 0.7rem; padding: 4px; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 0.9rem; font-weight: 700; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: transform 0.1s, filter 0.2s;
        }
        .btn:active { transform: scale(0.97); filter: brightness(0.9); }
        .btn-gold { background: var(--gold); color: #000; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2); }
        .btn-red { background: var(--danger); color: #fff; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: #888; padding: 8px 12px; font-size: 0.8rem; }

        .input-block { margin-bottom: 15px; }
        .input-block label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; }
        select, input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: #fff; padding: 12px; border-radius: 8px; font-size: 1rem;
            outline: none; transition: border-color 0.2s;
        }
        select:focus, input:focus { border-color: var(--gold); }

        /* =========================================
           4. COMBAT & CHAT
           ========================================= */
        .enemy-rail {
            display: flex; gap: 12px; overflow-x: auto; padding: 5px 0 15px 0;
            scrollbar-width: none;
        }
        .enemy-rail::-webkit-scrollbar { display: none; }
        
        .enemy-card {
            flex: 0 0 100px;
            background: #101010; border: 1px solid #333; border-radius: 8px;
            position: relative; overflow: hidden; transition: transform 0.2s, border-color 0.2s;
            cursor: pointer;
        }
        .enemy-card.selected { border-color: var(--danger); box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); transform: scale(1.05); }
        .enemy-img { width: 100%; height: 90px; object-fit: cover; background: #000; border-bottom: 1px solid #333; }
        .enemy-info { padding: 6px; text-align: center; }
        .enemy-name { font-size: 0.7rem; font-weight: bold; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        
        .hp-mini-track { width: 100%; height: 4px; background: #330000; border-radius: 2px; overflow: hidden; }
        .hp-mini-fill { height: 100%; background: var(--danger); transition: width 0.3s; }

        .chat-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; }
        .chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: auto; }
        .chat-input-bar { flex-shrink: 0; padding: 10px; background: #101010; border-top: 1px solid var(--border); display: flex; gap: 10px; z-index: 10; }

        .log-item { background: #222; border-radius: 8px; padding: 12px; border-left: 3px solid #444; }
        .log-item.atk { border-left-color: var(--gold); background: linear-gradient(90deg, #1a1a1a, #1f1f10); }
        .log-item.dmg { border-left-color: var(--danger); background: linear-gradient(90deg, #1a1a1a, #1f1010); }
        .log-head { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-bottom: 4px; }
        .log-user { color: #fff; font-weight: 700; }
        .log-content { font-size: 0.95rem; line-height: 1.4; color: #eee; }
        .log-res { font-size: 1.2rem; font-weight: 700; color: #fff; margin-top: 4px; }
        .log-det { font-size: 0.75rem; color: #666; font-family: monospace; }

        /* =========================================
           5. MAP & AUDIO
           ========================================= */
        #map-container { width: 100%; height: 100%; background: #050505; position: relative; }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; cursor: grab; }
        
        .map-controls {
            position: absolute; bottom: 80px; right: 20px;
            display: flex; flex-direction: column; gap: 12px;
        }
        .fab-btn {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(20,20,20,0.85); backdrop-filter: blur(4px);
            border: 1px solid var(--border); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .fab-btn.audio-on { color: var(--success); border-color: var(--success); }
        .fab-btn:active { transform: scale(0.9); }

        .token-form {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 300px; background: rgba(20,20,20,0.95);
            backdrop-filter: blur(8px); border: 1px solid var(--gold); border-radius: 12px;
            padding: 15px; display: none; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .modal-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(4px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal-card {
            background: var(--bg-card); border: 1px solid var(--border);
            width: 100%; max-width: 400px; max-height: 80vh;
            border-radius: 16px; overflow-y: auto; padding: 24px;
            position: relative; animation: popIn 0.2s ease-out;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity:0; } to { transform: scale(1); opacity:1; } }

    </style>
</head>
<body>

<audio id="bg-music" loop></audio>

<header class="app-header">
    <div class="font-brand text-gold">ZATUR</div>
    <div class="header-avatar" id="avatar-circle">P</div>
</header>

<nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('sheet')"><i class="fas fa-scroll"></i><span>Ficha</span></button>
    <button class="nav-btn" onclick="switchTab('combat')"><i class="fas fa-fist-raised"></i><span>Combate</span></button>
    <button class="nav-btn" onclick="switchTab('chat')"><i class="fas fa-comment-alt"></i><span>Chat</span></button>
    <button class="nav-btn" onclick="switchTab('map')"><i class="fas fa-map"></i><span>Mapa</span></button>
</nav>

<main>

    <section id="sheet" class="view-section active">
        <div style="text-align:center; margin-bottom:25px;">
            <h2 class="font-brand" id="char-name">...</h2>
            <div class="text-sm" id="char-class">Carregando...</div>
        </div>

        <div class="status-header">
            <div class="stat-col">
                <div class="stat-meta"><span class="text-red">VIDA</span> <span id="hp-val">0/0</span></div>
                <div class="bar-track"><div id="hp-bar" class="bar-fill hp-fill" style="width:0%"></div></div>
            </div>
            <div class="stat-col">
                <div class="stat-meta"><span class="text-blue">MANA</span> <span id="mp-val">0/0</span></div>
                <div class="bar-track"><div id="mp-bar" class="bar-fill mp-fill" style="width:0%"></div></div>
            </div>
        </div>

        <div class="attr-grid">
            <div class="attr-card" onclick="rollAttribute('Força')"><div class="attr-label">FOR</div><div class="attr-val" id="val-for">0</div></div>
            <div class="attr-card" onclick="rollAttribute('Agilidade')"><div class="attr-label">AGI</div><div class="attr-val" id="val-agi">0</div></div>
            <div class="attr-card" onclick="rollAttribute('Intelecto')"><div class="attr-label">INT</div><div class="attr-val" id="val-int">0</div></div>
            <div class="attr-card" onclick="rollAttribute('Vigor')"><div class="attr-label">VIG</div><div class="attr-val" id="val-vig">0</div></div>
            <div class="attr-card" style="border-color:var(--mana)" onclick="rollAttribute('Mana')"><div class="attr-label text-blue">MANA</div><div class="attr-val" id="val-man">0</div></div>
        </div>

        <h4 class="text-gold font-brand" style="margin:25px 0 10px 0; border-bottom:1px solid #333; padding-bottom:5px;">Inventário</h4>
        <div id="inv-grid" class="grid-list"></div>

        <h4 class="text-blue font-brand" style="margin:25px 0 10px 0; border-bottom:1px solid #333; padding-bottom:5px;">Poderes</h4>
        <div id="spell-grid" class="grid-list"></div>
    </section>

    <section id="combat" class="view-section">
        <div style="max-width:600px; margin:0 auto;">
            
            <div style="margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <h4 class="text-red font-brand" style="margin:0">Inimigos</h4>
                    <span class="text-sm">Toque para mirar</span>
                </div>
                <div id="enemy-rail" class="enemy-rail">
                    <div style="padding:10px; color:#666; font-size:0.9rem;">Nenhum inimigo visível.</div>
                </div>
            </div>

            <div class="panel" style="border-color:var(--gold);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                    <div>
                        <div class="text-sm" style="color:#666; font-size:0.7rem; font-weight:700;">AÇÃO ATUAL</div>
                        <div class="font-brand text-gold" style="font-size:1.1rem;" id="combat-source">Ataque Básico</div>
                    </div>
                    <button class="btn-ghost" onclick="resetCombatSource()"><i class="fas fa-undo"></i></button>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div class="input-block">
                        <label>Atributo Base</label>
                        <select id="atk-attr"><option value="manual">Manual</option></select>
                    </div>
                    <div class="input-block">
                        <label>Dado Acerto</label>
                        <select id="atk-face">
                            <option value="20" selected>d20</option>
                            <option value="12">d12</option>
                            <option value="10">d10</option>
                            <option value="100">d100</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-block" id="manual-row" style="display:none;">
                    <label>Qtd. Dados</label>
                    <input type="number" id="atk-qty" value="1">
                </div>

                <div class="input-block">
                    <label>Modificador</label>
                    <input type="number" id="atk-mod" placeholder="+0">
                </div>

                <button class="btn btn-gold" onclick="rollAttack()">ROLAR ACERTO</button>
            </div>

            <div class="panel" style="border-color:var(--danger);">
                <div class="input-block">
                    <label class="text-red">Alvo Selecionado</label>
                    <select id="target-select" style="border-color:var(--danger); font-weight:bold;">
                        <option value="">-- Ninguém --</option>
                    </select>
                </div>

                <div style="display:grid; grid-template-columns: 0.6fr 1fr; gap:10px;">
                    <div class="input-block">
                        <label>Qtd.</label>
                        <input type="number" id="dmg-qty" value="1">
                    </div>
                    <div class="input-block">
                        <label>Tipo</label>
                        <select id="dmg-face">
                            <option value="4">d4</option>
                            <option value="6" selected>d6</option>
                            <option value="8">d8</option>
                            <option value="10">d10</option>
                            <option value="12">d12</option>
                            <option value="20">d20</option>
                        </select>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="input-block">
                        <label>Extra</label>
                        <input type="number" id="dmg-mod" value="0">
                    </div>
                    <div class="input-block">
                        <label class="text-blue">Custo Mana</label>
                        <input type="number" id="dmg-cost" value="0" style="border-color:#1e3a8a;">
                    </div>
                </div>

                <button class="btn btn-red" onclick="previewDamage()">CALCULAR DANO</button>

                <div id="dmg-preview" style="display:none; background:#000; padding:15px; border-radius:8px; margin-top:15px; border:1px solid var(--danger); text-align:center;">
                    <div style="font-size:0.75rem; color:#888;">RESULTADO</div>
                    <div style="font-size:2.2rem; font-weight:800; color:#fff;" id="preview-val">0</div>
                    <div id="preview-cost" style="font-size:0.8rem; color:var(--mana); margin-bottom:10px;"></div>
                    <button class="btn btn-gold" id="btn-commit" onclick="commitDamage()">CONFIRMAR E APLICAR</button>
                </div>
            </div>

        </div>
    </section>

    <section id="chat" class="view-section">
        <div class="chat-container">
            <div id="chat-feed" class="chat-feed">
                </div>
            <div class="chat-input-bar">
                <input type="text" id="chat-input" placeholder="Mensagem..." onfocus="forceScrollBottom()">
                <button class="btn btn-gold" style="width:auto; padding:0 20px;" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </section>

    <section id="map" class="view-section">
        <div id="map-container">
            <canvas id="gameCanvas"></canvas>
            
            <div class="map-controls">
                <button id="btn-audio" class="fab-btn" onclick="enableAudio()" style="display:none;"><i class="fas fa-music"></i></button>
                
                <button class="fab-btn" onclick="toggleTokenCreator()"><i class="fas fa-plus"></i></button>
                <button class="fab-btn" onclick="zoomMap(0.1)"><i class="fas fa-search-plus"></i></button>
                <button class="fab-btn" onclick="zoomMap(-0.1)"><i class="fas fa-search-minus"></i></button>
            </div>

            <div id="token-form" class="token-form">
                <h4 class="text-gold" style="margin:0 0 10px 0;">Novo Token</h4>
                <div class="input-block">
                    <label>Carregar Personagem</label>
                    <select id="tk-char-select" onchange="fillTokenData()">
                        <option value="">-- Personalizado --</option>
                    </select>
                </div>
                <div class="input-block"><label>Nome</label><input type="text" id="tk-name" placeholder="Nome"></div>
                <div class="input-block"><label>Imagem URL</label><input type="text" id="tk-img" placeholder="https://..."></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-gold" onclick="createToken()">CRIAR</button>
                    <button class="btn btn-ghost" onclick="toggleTokenCreator()">CANCELAR</button>
                </div>
            </div>
        </div>
    </section>

</main>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 class="font-brand text-gold" id="m-title" style="margin:0;">Item</h3>
            <button onclick="closeModal()" style="background:none; border:none; color:#fff; font-size:1.5rem;">&times;</button>
        </div>
        <div id="m-img-con" style="text-align:center; margin-bottom:15px;"></div>
        <div id="m-desc" style="color:#ccc; font-size:0.9rem; line-height:1.5; margin-bottom:20px; max-height:150px; overflow-y:auto;"></div>
        <div id="m-stats" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; background:#111; padding:12px; border-radius:8px; margin-bottom:20px;"></div>
        <button class="btn btn-gold" onclick="equipItem()">USAR EM COMBATE</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, collection, addDoc, getDocs, updateDoc, onSnapshot, getDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgYVod9B99WIc_QysFx73htOf9O8XtuE8",
        authDomain: "zatur-rpg.firebaseapp.com",
        projectId: "zatur-rpg",
        storageBucket: "zatur-rpg.firebasestorage.app",
        messagingSenderId: "797058283992",
        appId: "1:797058283992:web:7132e71691a225c1255aad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let charId = null;
    let charData = null;
    let currentItem = null;
    let activeSource = "Ataque Básico";
    let pendingDmg = 0;
    let pendingCost = 0;
    let lastRollDetails = "";
    let characterList = [];
    let currentMusicUrl = "";

    window.onload = async () => {
        const params = new URLSearchParams(window.location.search);
        charId = params.get('id');
        if(!charId) return document.body.innerHTML = "<div style='color:#fff;text-align:center;padding:50px;'>ID inválido</div>";
        
        const snap = await getDocs(collection(db, "characters"));
        const tkSel = document.getElementById('tk-char-select');
        snap.forEach(d => {
            const c = d.data();
            characterList.push({ id: d.id, ...c });
            tkSel.innerHTML += `<option value="${d.id}">${c.Nome}</option>`;
        });

        initListeners();
    };

    window.forceScrollBottom = () => {
        const feed = document.getElementById('chat-feed');
        if(feed) {
            feed.scrollTop = feed.scrollHeight;
            setTimeout(() => feed.scrollTop = feed.scrollHeight, 100);
        }
    };

    function initListeners() {
        onSnapshot(doc(db, "characters", charId), (snap) => {
            if(!snap.exists()) return;
            charData = snap.data();
            renderUI();
        });

        onSnapshot(collection(db, "active_encounters"), (snap) => {
            const rail = document.getElementById('enemy-rail');
            const sel = document.getElementById('target-select');
            const currentSel = sel.value;
            
            rail.innerHTML = "";
            sel.innerHTML = `<option value="">-- Ninguém --</option>`;
            if(snap.empty) rail.innerHTML = "<div style='padding:10px;color:#666'>Sem inimigos</div>";

            snap.forEach(d => {
                const m = d.data();
                if(m['Pontos de Vida Atual'] > 0) {
                    sel.innerHTML += `<option value="${d.id}">${m.Nome} (${m['Pontos de Vida Atual']} HP)</option>`;
                    const hpPct = Math.min(100, (m['Pontos de Vida Atual'] / m['Pontos de Vida Max'])*100);
                    const img = m.Imagem || "https://via.placeholder.com/100?text=Enemy";
                    const card = document.createElement('div');
                    card.className = 'enemy-card';
                    card.innerHTML = `
                        <img src="${img}" class="enemy-img">
                        <div class="enemy-info"><div class="enemy-name">${m.Nome}</div><div class="hp-mini-track"><div class="hp-mini-fill" style="width:${hpPct}%"></div></div></div>
                    `;
                    card.onclick = () => { 
                        document.getElementById('target-select').value = d.id; 
                        document.querySelectorAll('.enemy-card').forEach(c=>c.classList.remove('selected'));
                        card.classList.add('selected');
                    };
                    rail.appendChild(card);
                }
            });
            sel.value = currentSel;
        });

        const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(30));
        onSnapshot(q, (snap) => {
            const feed = document.getElementById('chat-feed');
            let html = "";
            const logs = [];
            snap.forEach(d => logs.push(d.data()));
            logs.reverse().forEach(l => {
                if(l.type === 'chat') {
                    html += `<div class="log-item"><div class="log-head"><span class="log-user" style="color:var(--text-main)">${l.charName}</span></div><div class="log-content">"${l.message}"</div></div>`;
                } else {
                    const cls = l.actionName.includes('Ataque') ? 'atk' : 'dmg';
                    html += `<div class="log-item ${cls}"><div class="log-head"><span class="log-user">${l.charName}</span><span>${l.actionName}</span></div><div class="log-res">${l.total}</div>${l.detail ? `<div class="log-det">${l.detail}</div>` : ''}${l.damageApplied ? `<div class="log-det" style="color:#fff;margin-top:4px;">${l.damageApplied}</div>` : ''}</div>`;
                }
            });
            feed.innerHTML = html;
            window.forceScrollBottom();
        });

        initMap();
        onSnapshot(doc(db, "campaign_settings", "global"), (snap) => {
            if(snap.exists()) {
                const d = snap.data();
                if(d.mapa_url) loadMap(d.mapa_url);
                if(d.posicoes) { tokens = d.posicoes; draw(); }
                
                // MUSIC LOGIC
                if(d.musica_url && d.musica_url !== currentMusicUrl) {
                    currentMusicUrl = d.musica_url;
                    const audio = document.getElementById('bg-music');
                    audio.src = currentMusicUrl;
                    audio.play().catch(e => {
                        console.log("Audio blocked", e);
                        document.getElementById('btn-audio').style.display = 'flex';
                    });
                }
            }
        });
    }

    // AUDIO CONTROL
    window.enableAudio = () => {
        const audio = document.getElementById('bg-music');
        if(currentMusicUrl) {
            audio.src = currentMusicUrl;
            audio.play();
            document.getElementById('btn-audio').style.display = 'none';
        }
    };

    function renderUI() {
        document.getElementById('avatar-circle').innerText = charData.Nome.charAt(0);
        document.getElementById('char-name').innerText = charData.Nome;
        document.getElementById('char-class').innerText = `Nível ${charData.Nivel || 1} ${charData.Classe || ''}`;
        const hpPct = Math.min(100, (charData['Pontos de Vida Atual']/charData['Pontos de Vida Max'])*100);
        const mpPct = Math.min(100, (charData['Pontos de Mana Atual']/charData['Pontos de Mana Max'])*100);
        document.getElementById('hp-bar').style.width = hpPct+"%";
        document.getElementById('hp-val').innerText = `${charData['Pontos de Vida Atual']}/${charData['Pontos de Vida Max']}`;
        document.getElementById('mp-bar').style.width = mpPct+"%";
        document.getElementById('mp-val').innerText = `${charData['Pontos de Mana Atual']}/${charData['Pontos de Mana Max']}`;

        ['for','agi','int','vig','mana'].forEach(k => {
            const map = {'for':'Força','agi':'Agilidade','int':'Intelecto','vig':'Vigor','mana':'Mana'};
            const val = charData[map[k]] || (k==='mana'? (charData.Intelecto||0) : 0);
            document.getElementById(`val-${k}`).innerText = val;
        });
        const sel = document.getElementById('atk-attr');
        if(sel.options.length <= 1) {
            ['Força','Agilidade','Intelecto','Vigor','Mana'].forEach(k => {
                if(charData[k]) sel.innerHTML += `<option value="${charData[k]}">${k} (${charData[k]})</option>`;
            });
        }
        renderGrid('inv-grid', charData.Itens);
        renderGrid('spell-grid', [...(charData.Magias||[]), ...(charData.Habilidades||[]), ...(charData.Pericias||[])]);
    }

    async function renderGrid(id, list) {
        if(!list) return;
        const c = document.getElementById(id);
        c.innerHTML = "";
        for(const itemId of list) {
            let item = null;
            for(const col of ['items','spells','abilities','skills']) {
                try { const snap = await getDoc(doc(db, col, itemId)); if(snap.exists()) { item = snap.data(); break; } } catch(e){}
            }
            if(item) {
                const div = document.createElement('div');
                div.className = 'grid-item';
                let img = item.Imagem ? `<img src="${item.Imagem}" class="grid-thumb">` : `<div class="grid-thumb" style="background:#222;display:flex;justify-content:center;align-items:center"><i class="fas fa-cube"></i></div>`;
                div.innerHTML = `${img}<div class="grid-name">${item.Nome}</div>`;
                div.onclick = () => openModal(item);
                c.appendChild(div);
            }
        }
    }

    window.rollAttribute = async (name) => {
        let val = parseInt(document.getElementById(`val-${name.substring(0,3).toLowerCase()}`).innerText) || 0;
        let count = Math.max(1, val);
        let rolls = []; for(let i=0; i<count; i++) rolls.push(Math.floor(Math.random()*20)+1);
        const best = Math.max(...rolls);
        await addDoc(collection(db, "logs"), { type: 'roll', charName: charData.Nome, actionName: `Teste de ${name}`, total: best, detail: `${count}d20: [${rolls.join(', ')}]`, timestamp: serverTimestamp() });
        switchTab('chat');
    };

    window.rollAttack = async () => {
        const val = document.getElementById('atk-attr').value;
        const qty = val === 'manual' ? parseInt(document.getElementById('atk-qty').value) : parseInt(val);
        const face = parseInt(document.getElementById('atk-face').value);
        const mod = parseInt(document.getElementById('atk-mod').value)||0;
        let rolls = []; for(let i=0; i<qty; i++) rolls.push(Math.floor(Math.random()*face)+1);
        const best = Math.max(...rolls);
        await addDoc(collection(db, "logs"), { type: 'roll', charName: charData.Nome, actionName: `Ataque (${activeSource})`, total: best+mod, detail: `${qty}d${face}: [${rolls.join(', ')}] + Mod ${mod}`, timestamp: serverTimestamp() });
        switchTab('chat');
    };

    window.previewDamage = () => {
        const qty = parseInt(document.getElementById('dmg-qty').value);
        const face = parseInt(document.getElementById('dmg-face').value);
        const mod = parseInt(document.getElementById('dmg-mod').value)||0;
        pendingCost = parseInt(document.getElementById('dmg-cost').value)||0;
        let sum = 0; let rolls = [];
        for(let i=0; i<qty; i++) { let r = Math.floor(Math.random()*face)+1; rolls.push(r); sum += r; }
        pendingDmg = sum + mod;
        lastRollDetails = `${qty}d${face}: [${rolls.join(', ')}] + Mod ${mod}`;
        document.getElementById('dmg-preview').style.display = 'block';
        document.getElementById('preview-val').innerText = pendingDmg;
        document.getElementById('preview-cost').innerText = pendingCost > 0 ? `-${pendingCost} Mana` : '';
    };

    window.commitDamage = async () => {
        const target = document.getElementById('target-select').value;
        if(!target) return alert("Selecione um alvo!");
        const btn = document.getElementById('btn-commit'); btn.disabled = true;
        try {
            if(pendingCost > 0) {
                if(charData['Pontos de Mana Atual'] < pendingCost) { alert("Sem Mana!"); btn.disabled=false; return; }
                await updateDoc(doc(db, "characters", charId), { 'Pontos de Mana Atual': charData['Pontos de Mana Atual'] - pendingCost });
            }
            const tRef = doc(db, "active_encounters", target);
            const tSnap = await getDoc(tRef);
            if(tSnap.exists()) {
                const tm = tSnap.data();
                const nhp = Math.max(0, tm['Pontos de Vida Atual'] - pendingDmg);
                await updateDoc(tRef, { 'Pontos de Vida Atual': nhp });
                let appText = `Causou ${pendingDmg} em ${tm.Nome}`;
                if(pendingCost > 0) appText += ` (${pendingCost} PM)`;
                await addDoc(collection(db, "logs"), { type: 'roll', charName: charData.Nome, actionName: `Dano (${activeSource})`, total: pendingDmg, detail: lastRollDetails, damageApplied: appText, timestamp: serverTimestamp() });
                document.getElementById('dmg-preview').style.display = 'none';
                switchTab('chat');
            }
        } catch(e){ console.error(e); }
        btn.disabled = false;
    };

    window.sendChat = async () => {
        const i = document.getElementById('chat-input');
        if(!i.value.trim()) return;
        await addDoc(collection(db, "logs"), { type:'chat', charName:charData.Nome, message:i.value, timestamp:serverTimestamp() });
        i.value = "";
        window.forceScrollBottom();
    };

    window.openModal = (i) => {
        currentItem = i;
        const m = document.getElementById('modal-overlay');
        document.getElementById('m-title').innerText = i.Nome;
        document.getElementById('m-desc').innerText = i.Descrição || i.Descricao || "";
        document.getElementById('m-img-con').innerHTML = i.Imagem ? `<img src="${i.Imagem}" style="max-height:150px;border-radius:8px">` : "";
        const s = document.getElementById('m-stats');
        s.innerHTML = "";
        ['Dano','Bonus','Custo'].forEach(k => { if(i[k]) s.innerHTML += `<div><span style="font-size:0.7rem;color:#888">${k}</span><br><strong>${i[k]}</strong></div>`; });
        m.style.display = 'flex';
    };
    window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';
    
    window.equipItem = () => {
        if(!currentItem) return;
        activeSource = currentItem.Nome;
        document.getElementById('combat-source').innerText = activeSource;
        if(currentItem.Dano) {
            const p = currentItem.Dano.toLowerCase().split('d');
            if(p.length===2) { document.getElementById('dmg-qty').value=p[0]; document.getElementById('dmg-face').value=p[1]; }
        }
        if(currentItem.Bonus) document.getElementById('atk-mod').value = currentItem.Bonus;
        if(currentItem.Custo) document.getElementById('dmg-cost').value = currentItem.Custo;
        closeModal();
        switchTab('combat');
    };

    window.resetCombatSource = () => {
        activeSource = "Ataque Básico";
        document.getElementById('combat-source').innerText = activeSource;
        document.getElementById('atk-mod').value = 0; document.getElementById('dmg-cost').value = 0;
    };

    window.switchTab = (id) => {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const idx = id==='sheet'?0:(id==='combat'?1:(id==='chat'?2:3));
        document.querySelectorAll('.nav-btn')[idx].classList.add('active');
        if(id==='map') setTimeout(resizeMap, 50);
        if(id==='chat') window.forceScrollBottom();
    };

    document.getElementById('atk-attr').addEventListener('change', function() {
        document.getElementById('manual-row').style.display = this.value==='manual'?'block':'none';
    });

    window.toggleTokenCreator = () => {
        const f = document.getElementById('token-form');
        f.style.display = f.style.display==='block'?'none':'block';
    };

    window.fillTokenData = () => {
        const id = document.getElementById('tk-char-select').value;
        if(!id) return;
        const char = characterList.find(c => c.id === id);
        if(char) {
            document.getElementById('tk-name').value = char.Nome;
            document.getElementById('tk-img').value = char.Imagem || "";
        }
    };

    window.createToken = () => {
        const name = document.getElementById('tk-name').value || "P";
        const img = document.getElementById('tk-img').value;
        const id = "tk_" + Date.now();
        const cx = (canvas.width/2 - view.x) / view.zoom;
        const cy = (canvas.height/2 - view.y) / view.zoom;
        tokens[id] = { x:cx, y:cy, size:60, name:name, img:img };
        updateDoc(doc(db,"campaign_settings","global"), { posicoes: tokens });
        toggleTokenCreator();
    };

    let canvas, ctx, mapImg, tokens = {}, view = {x:0, y:0, zoom:1};
    let isDrag = false, lastPos = {x:0, y:0}, dragToken = null;

    function initMap() {
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        resizeMap();
        window.onresize = resizeMap;
        const start = (x,y) => {
            const wx = (x - view.x)/view.zoom;
            const wy = (y - view.y)/view.zoom;
            let hit = null;
            Object.keys(tokens).forEach(k => {
                const t = tokens[k];
                const dx = t.x - wx; const dy = t.y - wy;
                if(Math.sqrt(dx*dx + dy*dy) < (t.size/2)) hit = k;
            });
            if(hit) dragToken = hit; else isDrag = true;
            lastPos = {x,y};
        };
        const move = (x,y) => {
            const dx = x - lastPos.x; const dy = y - lastPos.y;
            lastPos = {x,y};
            if(dragToken) {
                tokens[dragToken].x += dx/view.zoom; tokens[dragToken].y += dy/view.zoom;
                draw();
            } else if(isDrag) {
                view.x += dx; view.y += dy;
                draw();
            }
        };
        const end = () => {
            if(dragToken) {
                updateDoc(doc(db,"campaign_settings","global"), { posicoes: tokens });
                dragToken = null;
            }
            isDrag = false;
        };
        canvas.addEventListener('touchstart', e => start(e.touches[0].clientX, e.touches[0].clientY), {passive:false});
        canvas.addEventListener('touchmove', e => { e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        canvas.addEventListener('touchend', end);
        canvas.onmousedown = e => start(e.clientX, e.clientY);
        canvas.onmousemove = e => move(e.clientX, e.clientY);
        canvas.onmouseup = end;
    }

    function loadMap(url) { mapImg = new Image(); mapImg.crossOrigin = "anonymous"; mapImg.src = url; mapImg.onload = draw; }

    function draw() {
        if(!ctx) return;
        ctx.fillStyle = "#000"; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.save(); ctx.translate(view.x, view.y); ctx.scale(view.zoom, view.zoom);
        if(mapImg) ctx.drawImage(mapImg, 0, 0);
        Object.values(tokens).forEach(t => {
            ctx.save();
            ctx.beginPath(); ctx.arc(t.x, t.y, t.size/2, 0, Math.PI*2);
            ctx.fillStyle = "#222"; ctx.fill();
            ctx.strokeStyle = "gold"; ctx.lineWidth = 2; ctx.stroke();
            
            // CYAN NAME WITH STROKE
            ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
            ctx.strokeStyle = "#000"; ctx.lineWidth = 4;
            ctx.strokeText(t.name||"T", t.x, t.y+t.size/2+15);
            ctx.fillStyle = "#00ffff"; 
            ctx.fillText(t.name||"T", t.x, t.y+t.size/2+15);
            ctx.restore();
        });
        ctx.restore();
    }

    function resizeMap() {
        if(canvas) {
            const p = document.getElementById('map-container');
            if(p.clientWidth) { canvas.width = p.clientWidth; canvas.height = p.clientHeight; draw(); }
        }
    }
    window.zoomMap = (d) => { view.zoom = Math.max(0.1, view.zoom+d); draw(); };

</script>
</body>
</html>
