<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zatur - Mesa Virtual Definitiva</title>
    <style>
        /* FONTES */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=MedievalSharp&family=Roboto:wght@400;500;700&display=swap');

        /* VARI√ÅVEIS DE COR */
        :root {
            --gold: #d4af37; 
            --gold-dim: #8a7018;
            --bg-dark: #0c0805; 
            --panel-bg: rgba(18, 14, 10, 0.98);
            --danger: #b91c1c;
            --danger-dim: #7f1d1d;
            --mana: #1e4d8c;
            --text-main: #e5e5e5;
            --chat-bg: rgba(0, 0, 0, 0.6);
        }

        /* GERAL */
        body { margin: 0; overflow: hidden; background: #000; font-family: 'MedievalSharp', cursive; color: var(--text-main); user-select: none; }
        * { box-sizing: border-box; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 3px; }

        /* === TELA DE START === */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        #btn-enter {
            padding: 15px 50px; font-size: 1.5rem; background: transparent; color: var(--gold);
            border: 2px solid var(--gold); font-family: 'Cinzel'; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 3px; transition: 0.3s;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        #btn-enter:hover { background: var(--gold); color: #000; box-shadow: 0 0 40px var(--gold); }

        /* === MISS√ÉO ATUAL (NOVO) === */
        #mission-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 20; background: linear-gradient(90deg, transparent, rgba(0,0,0,0.9), transparent);
            padding: 10px 40px; border-bottom: 2px solid var(--gold-dim);
            text-align: center; pointer-events: none; width: 60%;
        }
        .mission-title { color: var(--gold); font-family: 'Cinzel'; font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .mission-text { color: #fff; font-family: 'MedievalSharp'; font-size: 1.4rem; text-shadow: 0 2px 4px #000; }

        /* === MAPA === */
        #map-layer { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; background: #080808; }
        
        #bottom-controls {
            position: absolute; bottom: 20px; left: 20px; z-index: 5;
            display: flex; flex-direction: column; gap: 10px;
        }
        .control-grp { display: flex; gap: 5px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 5px; border: 1px solid #333; }
        .map-btn { width: 32px; height: 32px; cursor: pointer; background: #222; color: var(--gold); border: 1px solid #444; border-radius: 3px; font-size: 1.2rem; display:flex; align-items:center; justify-content:center; }
        .map-btn:hover { background: #444; border-color: var(--gold); }

        /* === HUD LATERAL === */
        #ui-layer {
            position: absolute; top: 0; right: 0; height: 100vh; width: 380px;
            background: var(--panel-bg); border-left: 3px solid var(--gold-dim);
            z-index: 10; display: flex; flex-direction: column;
            box-shadow: -10px 0 50px rgba(0,0,0,1);
            transition: transform 0.3s ease;
        }

        /* CABE√áALHO DO PERSONAGEM */
        .char-header { padding: 20px; background: linear-gradient(to bottom, #1a120b, #0c0907); border-bottom: 1px solid var(--gold-dim); }
        .char-name { margin: 0; color: var(--gold); font-family: 'Cinzel'; font-size: 1.6rem; text-transform: uppercase; text-shadow: 0 2px 4px #000; }
        .char-details { font-size: 0.8rem; color: #888; margin-bottom: 10px; font-family: 'Roboto'; font-style: italic; }
        
        /* BARRAS DE VIDA/MANA */
        .bars-container { display: flex; flex-direction: column; gap: 6px; }
        .bar-wrap { position: relative; height: 20px; background: #000; border: 1px solid #444; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.4s ease; }
        .bar-txt { position: absolute; width: 100%; text-align: center; top: 0; line-height: 20px; font-size: 0.75rem; font-family: 'Roboto'; font-weight: bold; text-shadow: 1px 1px 2px #000; z-index: 2; color: #fff; }

        /* ABAS DE NAVEGA√á√ÉO */
        .nav-tabs { display: flex; background: #050505; border-bottom: 1px solid #333; }
        .nav-btn {
            flex: 1; padding: 12px; background: none; border: none; color: #555;
            font-family: 'Cinzel'; font-weight: bold; cursor: pointer; 
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .nav-btn:hover { color: #aaa; }
        .nav-btn.active { color: var(--gold); border-bottom-color: var(--gold); background: linear-gradient(to top, rgba(212,175,55,0.1), transparent); }

        /* CONTE√öDO DAS ABAS */
        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; flex-direction: column; gap: 15px; }
        .tab-content.active { display: flex; }

        /* CARDS E LISTAS */
        .section-label { color: var(--gold); border-bottom: 1px solid #333; font-family: 'Cinzel'; margin-bottom: 5px; font-size: 0.9rem; }
        
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .attr-card { 
            background: rgba(255,255,255,0.03); border: 1px solid #333; padding: 8px; 
            text-align: center; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .attr-card:hover { border-color: var(--gold); transform: translateY(-2px); background: rgba(212,175,55,0.1); }
        .attr-val { font-size: 1.2rem; font-weight: bold; color: var(--gold); display: block; }
        .attr-lbl { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }

        /* LISTA DE ITENS/MAGIAS */
        .list-item { 
            background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 4px; 
            margin-bottom: 5px; overflow: hidden; transition: 0.2s;
        }
        .list-header { 
            padding: 10px; display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; background: rgba(255,255,255,0.02);
        }
        .list-header:hover { background: rgba(255,255,255,0.05); }
        .list-body { 
            padding: 10px; font-family: 'Roboto'; font-size: 0.85rem; color: #ccc; 
            background: rgba(0,0,0,0.6); border-top: 1px dashed #333; display: none; 
        }
        .list-body.open { display: block; }
        .btn-roll-mini { background: none; border: 1px solid #444; color: var(--gold); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; }
        .btn-roll-mini:hover { background: var(--gold); color: black; }

        /* COMBATE */
        .combat-card {
            border: 1px solid var(--danger-dim); background: linear-gradient(90deg, #1a0505, #0f0505);
            padding: 10px; border-radius: 6px; display: flex; flex-direction: column; gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .combat-row { display: flex; gap: 10px; align-items: flex-start; }
        .enemy-thumb { width: 60px; height: 60px; object-fit: cover; border: 1px solid var(--danger); background: black; border-radius: 4px; }
        .enemy-stats { flex: 1; }
        .enemy-name { font-family: 'Cinzel'; color: #ff9999; font-size: 1rem; }
        .enemy-desc { font-family: 'Roboto'; font-size: 0.75rem; color: #aaa; margin: 2px 0 5px 0; font-style: italic; }
        
        .hp-bar-enemy { height: 6px; background: #300; width: 100%; border-radius: 2px; overflow: hidden; }
        .hp-fill-enemy { height: 100%; background: var(--danger); display: block; transition: 0.3s; }

        .btn-attack-main {
            width: 100%; background: linear-gradient(to bottom, #8b0000, #500);
            color: white; font-family: 'Cinzel'; border: 1px solid #a00; padding: 6px;
            cursor: pointer; font-weight: bold; letter-spacing: 1px;
        }
        .btn-attack-main:hover { filter: brightness(1.2); }

        /* CHAT */
        #log-container { 
            flex: 1; overflow-y: auto; padding-right: 5px; font-family: 'Roboto'; 
            display: flex; flex-direction: column; gap: 8px;
        }
        .msg { padding: 8px; border-radius: 4px; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; }
        .msg-chat { background: rgba(255,255,255,0.05); border-left: 2px solid #555; }
        .msg-roll { background: rgba(0,0,0,0.4); border: 1px solid #333; }
        .msg-author { color: var(--gold); font-weight: bold; font-family: 'Cinzel'; margin-right: 5px; }
        .msg-result { float: right; font-size: 1.1rem; font-weight: bold; color: #fff; background: #222; padding: 2px 8px; border-radius: 4px; }
        .crit { color: var(--gold); border: 1px solid var(--gold); box-shadow: 0 0 5px var(--gold); }
        .fumble { color: #ff4444; border: 1px solid #ff0000; }
        
        .chat-input-box { display: flex; gap: 5px; margin-top: auto; padding-top: 10px; border-top: 1px solid #333; }
        .inp-chat { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; font-family: 'Roboto'; }
        .btn-send { background: var(--gold); border: none; padding: 0 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }

        /* MESTRE (GM) */
        #gm-btn { position: absolute; top: 10px; left: 10px; z-index: 50; background: #222; color: var(--gold); border: 1px solid var(--gold); width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #gm-panel { position: absolute; top: 50px; left: 10px; background: var(--panel-bg); border: 1px solid var(--gold); padding: 15px; width: 260px; display: none; z-index: 50; border-radius: 5px; }
        .gm-inp { width: 100%; background: #000; color: #fff; border: 1px solid #444; padding: 5px; margin-bottom: 5px; }

        /* MODAL DE A√á√ÉO */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: rgba(0,0,0,0.8); z-index: 100; display: none; 
            align-items: center; justify-content: center; backdrop-filter: blur(3px); 
        }
        .modal-box { 
            background: #111; border: 2px solid var(--gold); padding: 25px; 
            width: 350px; text-align: center; border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .big-number { font-size: 4rem; font-family: 'Cinzel'; margin: 10px 0; color: #fff; }
        .btn-action { width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; font-weight: bold; border: none; border-radius: 4px; }
        .btn-confirm { background: var(--danger); color: white; border: 1px solid #f00; }
        .btn-roll { background: var(--gold); color: black; }
        .btn-close { background: transparent; color: #777; text-decoration: underline; margin-top: 10px; }

    </style>
</head>
<body>

<div id="start-overlay">
    <h1 style="font-family:'Cinzel'; font-size:4rem; color:var(--gold); margin:0; text-shadow:0 0 20px black;">ZATUR</h1>
    <p style="color:#aaa; font-family:'Roboto'; letter-spacing:1px; margin-bottom:40px;">Mesa de RPG Virtual v3.1</p>
    <button id="btn-enter" onclick="enterGame()">Entrar na Sess√£o</button>
</div>

<div id="mission-bar">
    <span class="mission-title">üìú Objetivo Atual</span>
    <div id="mission-display" class="mission-text">Aguardando ordens...</div>
</div>

<audio id="bg-audio" loop></audio>

<div id="map-layer">
    <canvas id="gameCanvas"></canvas>
    <div id="bottom-controls">
        <div class="control-grp">
            <button class="map-btn" onclick="zoomMap(0.1)">+</button>
            <button class="map-btn" onclick="zoomMap(-0.1)">-</button>
            <button class="map-btn" onclick="resetView()">‚ü≤</button>
        </div>
        <div class="control-grp">
            <button class="map-btn" onclick="toggleMute()" id="mute-icon">üîä</button>
            <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="setVolume(this.value)" style="width:80px; accent-color:var(--gold);">
        </div>
    </div>
</div>

<div id="gm-btn" onclick="toggleGM()">‚öôÔ∏è</div>
<div id="gm-panel">
    <p class="section-label">Configura√ß√£o da Cena</p>
    <input type="text" id="gm-map" class="gm-inp" placeholder="URL Imagem do Mapa">
    <input type="text" id="gm-music" class="gm-inp" placeholder="URL M√∫sica (MP3)">
    
    <input type="text" id="gm-mission-input" class="gm-inp" placeholder="Texto da Miss√£o Atual">
    
    <button class="btn-action btn-roll" onclick="syncWorld()">Sincronizar Mundo</button>
    
    <p class="section-label" style="margin-top:15px">Tokens</p>
    <input type="text" id="tk-name" class="gm-inp" placeholder="Nome NPC">
    <input type="text" id="tk-img" class="gm-inp" placeholder="URL Token">
    <button class="btn-action btn-roll" onclick="activateTokenPlacement()">Adicionar Token</button>
</div>

<aside id="ui-layer">
    <div class="char-header">
        <h2 id="hud-name" class="char-name">Carregando...</h2>
        <div id="hud-details" class="char-details">Classe, Ra√ßa Nvl 1</div>
        
        <div class="bars-container">
            <div class="bar-wrap">
                <span id="txt-hp" class="bar-txt">PV: 0/0</span>
                <div id="bar-hp" class="bar-fill" style="background:var(--danger); width:0%"></div>
            </div>
            <div class="bar-wrap">
                <span id="txt-mp" class="bar-txt">PM: 0/0</span>
                <div id="bar-mp" class="bar-fill" style="background:var(--mana); width:0%"></div>
            </div>
        </div>
    </div>

    <nav class="nav-tabs">
        <button class="nav-btn active" onclick="setTab('tab-sheet', this)">Ficha</button>
        <button class="nav-btn" onclick="setTab('tab-combat', this)" style="color:#ffaaaa">Combate</button>
        <button class="nav-btn" onclick="setTab('tab-chat', this)">Chat</button>
    </nav>

    <div id="tab-sheet" class="tab-content active">
        <div class="section-label">Atributos Base</div>
        <div id="grid-attrs" class="attr-grid"></div>

        <div class="section-label">Per√≠cias & Habilidades</div>
        <div id="list-skills"></div>

        <div class="section-label">Equipamento & Magias</div>
        <div id="list-inventory"></div>
    </div>

    <div id="tab-combat" class="tab-content">
        <div class="section-label" style="text-align:center; color:#ff5555;">Inimigos Ativos</div>
        <div id="list-enemies">
            <p style="text-align:center; color:#666; font-size:0.9rem; margin-top:20px;">Nenhum inimigo √† vista.</p>
        </div>
    </div>

    <div id="tab-chat" class="tab-content" style="height:100%;">
        <div id="log-container"></div>
        <div class="chat-input-box">
            <input type="text" id="inp-msg" class="inp-chat" placeholder="Escreva algo..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="btn-send" onclick="sendChat()">‚û§</button>
        </div>
    </div>
</aside>

<div id="modal-attack" class="modal-overlay">
    <div class="modal-box">
        <h3 style="color:var(--danger); margin:0; font-family:'Cinzel'">REALIZAR ATAQUE</h3>
        <p id="atk-target-label" style="color:#888; font-size:0.9rem; margin-bottom:15px">Alvo: Inimigo</p>
        
        <select id="atk-option" class="gm-inp" style="padding:10px; font-size:1rem;"></select>
        
        <div style="display:flex; justify-content:center; gap:15px; margin:15px 0;">
            <label><input type="radio" name="atk-mod" value="0" checked> Normal</label>
            <label style="color:var(--gold)"><input type="radio" name="atk-mod" value="5"> Vantagem</label>
            <label style="color:var(--danger)"><input type="radio" name="atk-mod" value="-5"> Desvantagem</label>
        </div>

        <button class="btn-action btn-roll" onclick="confirmAttack()">ROLAR DADO</button>
        <button class="btn-close" onclick="closeModal('modal-attack')">Cancelar</button>
    </div>
</div>

<div id="modal-result" class="modal-overlay">
    <div class="modal-box">
        <h3 style="color:#aaa; margin:0; font-size:1rem">RESULTADO</h3>
        <div id="res-val" class="big-number">0</div>
        <div id="res-msg" style="color:#ccc; font-size:0.9rem; margin-bottom:15px">Detalhes...</div>
        
        <button id="btn-dmg" class="btn-action btn-confirm" onclick="applyDamageFlow()">üí• APLICAR DANO</button>
        <button class="btn-close" onclick="closeModal('modal-result')">Fechar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, getDoc, collection, updateDoc, setDoc, addDoc, query, orderBy, limit, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgYVod9B99WIc_QysFx73htOf9O8XtuE8",
        authDomain: "zatur-rpg.firebaseapp.com",
        projectId: "zatur-rpg",
        storageBucket: "zatur-rpg.firebasestorage.app",
        messagingSenderId: "797058283992",
        appId: "1:797058283992:web:7132e71691a225c1255aad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const charId = new URLSearchParams(window.location.search).get("id");

    let playerData = {};
    let combatOptions = []; 
    let currentTargetId = null;
    let audio = document.getElementById('bg-audio');
    let hasInteracted = false;

    // --- INICIALIZA√á√ÉO ---
    window.enterGame = () => {
        document.getElementById('start-overlay').style.display = 'none';
        hasInteracted = true;
        if(audio.src) audio.play().catch(e => console.log("Audio play failed", e));
        if(!charId) alert("ID do personagem n√£o encontrado na URL! Modo Espectador/Mestre");
        initSystem();
    };

    function initSystem() {
        // Carregar Personagem (se houver ID)
        if(charId) {
            onSnapshot(doc(db, "characters", charId), (snap) => {
                if(!snap.exists()) return;
                playerData = snap.data();
                updateHUD();
                loadAssets();
            });
        }

        // Carregar Inimigos (Combate)
        onSnapshot(collection(db, "active_encounters"), (snap) => {
            const container = document.getElementById('list-enemies');
            container.innerHTML = "";
            if(snap.empty) {
                container.innerHTML = "<p style='text-align:center; color:#666'>Sem amea√ßas.</p>";
                return;
            }
            snap.forEach(d => {
                const en = d.data();
                const hpPercent = (en.PV / en.PV_Max) * 100;
                let hpColor = hpPercent > 50 ? "#22c55e" : (hpPercent > 25 ? "#eab308" : "var(--danger)");
                
                container.innerHTML += `
                <div class="combat-card">
                    <div class="combat-row">
                        <img src="${en.Imagem || 'https://via.placeholder.com/60'}" class="enemy-thumb">
                        <div class="enemy-stats">
                            <div class="enemy-name">${en.Nome}</div>
                            <div class="hp-bar-enemy" style="background:#333; margin-top:5px;">
                                <span class="hp-fill-enemy" style="width:${hpPercent}%; background:${hpColor}"></span>
                            </div>
                        </div>
                    </div>
                    <button class="btn-attack-main" onclick="openAttackModal('${d.id}', '${en.Nome}')">‚öîÔ∏è ATACAR</button>
                </div>`;
            });
        });

        // Carregar Chat
        const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(30));
        onSnapshot(q, (snap) => {
            const container = document.getElementById('log-container');
            const msgs = [];
            snap.forEach(d => msgs.push(d.data()));
            msgs.reverse();
            container.innerHTML = "";
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.type === 'chat' ? 'msg-chat' : 'msg-roll'}`;
                if(m.type === 'chat') {
                    div.innerHTML = `<span class="msg-author">${m.charName}:</span> <span style="color:#ddd">${m.message}</span>`;
                } else {
                    let extraClass = m.isCrit ? "crit" : (m.isFumble ? "fumble" : "");
                    div.innerHTML = `
                        <div style="margin-bottom:2px">
                            <span class="msg-author">${m.charName}</span>
                            <span style="font-size:0.8rem; color:#aaa;">usou ${m.actionName}</span>
                            <span class="msg-result ${extraClass}">${m.total}</span>
                        </div>
                        <div style="font-size:0.75rem; color:#777;">${m.detail}</div>
                    `;
                }
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        });

        // Configura√ß√µes Globais (Mapa, Audio, Miss√£o)
        onSnapshot(doc(db,"campaign_settings","global"), (s) => {
            if(!s.exists()) return;
            const data = s.data();
            
            // Miss√£o Atual
            if(data.missao_atual) {
                document.getElementById('mission-display').innerText = data.missao_atual;
                document.getElementById('gm-mission-input').value = data.missao_atual;
            }

            // Mapa
            if(data.mapa_url && (!mapImg || mapImg.src !== data.mapa_url)) {
                mapImg = new Image(); 
                mapImg.crossOrigin = "anonymous";
                mapImg.src = data.mapa_url; 
                mapImg.onload = renderMap; 
                document.getElementById('gm-map').value = data.mapa_url;
            }
            
            // Audio
            if(data.musica_url && audio.src !== data.musica_url) {
                audio.src = data.musica_url;
                document.getElementById('gm-music').value = data.musica_url;
                if(hasInteracted) audio.play();
            }

            // Tokens (Atualiza posi√ß√µes em tempo real)
            tokens = data.posicoes || {};
            renderMap();
        });
        
        initCanvas();
    }

    // --- INTERFACE ---
    function updateHUD() {
        document.getElementById('hud-name').innerText = playerData.Nome || "Desconhecido";
        document.getElementById('hud-details').innerText = `${playerData.Classe || ''} ${playerData.Raca || ''} - Nvl ${playerData.Nivel || 1}`;
        document.getElementById('bar-hp').style.width = ((playerData.PV / playerData.PV_Max) * 100) + "%";
        document.getElementById('txt-hp').innerText = `PV: ${playerData.PV}/${playerData.PV_Max}`;
        document.getElementById('bar-mp').style.width = ((playerData.PE / playerData.PE_Max) * 100) + "%";
        document.getElementById('txt-mp').innerText = `PM: ${playerData.PE}/${playerData.PE_Max}`;
        
        const grid = document.getElementById('grid-attrs');
        grid.innerHTML = "";
        const attrs = ["For√ßa", "Agilidade", "Intelecto", "Vigor", "Presen√ßa"];
        attrs.forEach(a => {
            const val = playerData[a] || 0;
            grid.innerHTML += `<div class="attr-card" onclick="rollSimple('${a}', ${val})"><span class="attr-lbl">${a.substring(0,3)}</span><span class="attr-val">${val}</span></div>`;
        });
    }

    async function loadAssets() {
        const skillsDiv = document.getElementById('list-skills');
        const invDiv = document.getElementById('list-inventory');
        skillsDiv.innerHTML = ""; invDiv.innerHTML = "";
        combatOptions = [];

        // Per√≠cias
        const allSkills = [...(playerData.pericias || []), ...(playerData.habilidades || [])];
        if(allSkills.length === 0) skillsDiv.innerHTML = "<small style='color:#555'>Vazio.</small>";
        allSkills.forEach(s => {
            const match = s.match(/(.+)\s\(([\+\-]?\d+)\)/);
            const name = match ? match[1] : s;
            const bonus = match ? parseInt(match[2]) : 0;
            createListItem(skillsDiv, "üé≤", name, `B√¥nus: ${bonus}`, () => rollSimple(name, bonus));
            combatOptions.push({ name: name, type: 'Per√≠cia', bonus: bonus });
        });

        // Itens e Magias
        const extIds = [...(playerData.itens || []), ...(playerData.magias || [])];
        for(const id of extIds) {
            let data = null;
            let type = "Item";
            try {
                let snap = await getDoc(doc(db, "items", id));
                if(snap.exists()) { data = snap.data(); type = "Item"; }
                else {
                    snap = await getDoc(doc(db, "spells", id));
                    if(snap.exists()) { data = snap.data(); type = "Magia"; }
                }
            } catch(e) {}

            if(data) {
                const desc = data.Descricao || "";
                const stats = data.Dano ? `Dano: ${data.Dano}` : (data.Custo ? `Custo: ${data.Custo}` : "Item Geral");
                createListItem(invDiv, type === "Item"?"‚öîÔ∏è":"‚ú®", data.Nome, stats, () => rollSimple(data.Nome, 0), desc);
                combatOptions.push({ name: data.Nome, type: type, bonus: 0 });
            } else {
                createListItem(invDiv, "üì¶", id, "Invent√°rio", () => rollSimple(id, 0));
                combatOptions.push({ name: id, type: 'Item', bonus: 0 });
            }
        }
    }

    function createListItem(container, icon, title, subtitle, onClickRoll, description = null) {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
            <div class="list-header" onclick="toggleDetails(this)">
                <div><span style="margin-right:5px">${icon}</span> <strong>${title}</strong> <span style="font-size:0.75rem; color:#888; margin-left:5px">${subtitle}</span></div>
                <button class="btn-roll-mini" onclick="event.stopPropagation(); callRoll()">üé≤</button>
            </div>
            ${description ? `<div class="list-body">${description}</div>` : ''}
        `;
        // Hack para passar a fun√ß√£o de rolagem
        div.querySelector('.btn-roll-mini').onclick = (e) => { e.stopPropagation(); onClickRoll(); };
        container.appendChild(div);
    }
    window.toggleDetails = (el) => { const b=el.nextElementSibling; if(b) b.classList.toggle('open'); }

    // --- COMBATE E DADOS ---
    window.openAttackModal = (enemyId, enemyName) => {
        currentTargetId = enemyId;
        document.getElementById('modal-attack').style.display = 'flex';
        document.getElementById('atk-target-label').innerText = `Alvo: ${enemyName}`;
        const sel = document.getElementById('atk-option');
        sel.innerHTML = `<option value="Ataque B√°sico">üëä Ataque B√°sico (For√ßa)</option>`;
        combatOptions.forEach(opt => {
            sel.innerHTML += `<option value="${opt.name}">[${opt.type}] ${opt.name}</option>`;
        });
    };

    window.confirmAttack = () => {
        const action = document.getElementById('atk-option').value;
        const mod = parseInt(document.querySelector('input[name="atk-mod"]:checked').value);
        let attrBonus = playerData.For√ßa || 0;
        const opt = combatOptions.find(o => o.name === action);
        if(opt && opt.type === 'Per√≠cia') attrBonus = opt.bonus;
        else if(opt && opt.type === 'Magia') attrBonus = playerData.Intelecto || 0;

        const d20 = Math.floor(Math.random()*20)+1;
        const total = d20 + mod + attrBonus;
        
        addDoc(collection(db, "logs"), {
            charName: playerData.Nome || "Mestre", actionName: action,
            total: total, detail: `[${d20}] + B√¥nus(${attrBonus}) + Mod(${mod})`,
            isCrit: d20===20, isFumble: d20===1, type: 'roll', timestamp: serverTimestamp()
        });

        document.getElementById('modal-attack').style.display = 'none';
        showResultModal(total, `${action} vs Alvo`, d20===20, d20===1, true);
    };

    window.rollSimple = (name, bonus) => {
        const d20 = Math.floor(Math.random()*20)+1;
        const total = d20 + bonus;
        addDoc(collection(db, "logs"), {
            charName: playerData.Nome || "Mestre", actionName: name, total: total,
            detail: `[${d20}] + ${bonus}`, isCrit: d20===20, isFumble: d20===1, type: 'roll', timestamp: serverTimestamp()
        });
        showResultModal(total, name, d20===20, d20===1, false);
    };

    function showResultModal(val, txt, crit, fumble, showDmg) {
        const m = document.getElementById('modal-result');
        const v = document.getElementById('res-val');
        v.innerText = val;
        v.style.color = crit ? "var(--gold)" : (fumble ? "red" : "white");
        document.getElementById('res-msg').innerText = txt + (crit?" (CR√çTICO!)":"") + (fumble?" (FALHA!)":"");
        document.getElementById('btn-dmg').style.display = showDmg ? 'block' : 'none';
        m.style.display = 'flex';
    }

    window.applyDamageFlow = async () => {
        if(!currentTargetId) return;
        const dmg = parseInt(prompt("Quanto de dano?", "0"));
        if(!isNaN(dmg) && dmg > 0) {
            const ref = doc(db, "active_encounters", currentTargetId);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                const novo = Math.max(0, snap.data().PV - dmg);
                await updateDoc(ref, { PV: novo });
                addDoc(collection(db, "logs"), {
                    charName: "SISTEMA", message: `${snap.data().Nome} sofreu ${dmg} de dano!`, type: 'chat', timestamp: serverTimestamp()
                });
            }
        }
        closeModal('modal-result');
    };

    window.sendChat = () => {
        const i = document.getElementById('inp-msg');
        if(i.value.trim()) addDoc(collection(db,"logs"),{charName:playerData.Nome || "Mestre",message:i.value,type:'chat',timestamp:serverTimestamp()});
        i.value="";
    };

    window.closeModal = (id) => document.getElementById(id).style.display='none';
    window.setTab = (id,b) => {
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
        document.getElementById(id).classList.add('active'); b.classList.add('active');
    };

    // === CANVAS E L√ìGICA DO MAPA ===
    let canvas, ctx, mapImg;
    let tokens = {}; // { id: {x, y, size, img, name} }
    let view = {x:0, y:0, zoom:1};
    let isMapDrag = false, isTokenDrag = false;
    let dragTokenId = null;
    let lastPos = {x:0,y:0};
    let placingToken = false;

    function initCanvas() {
        canvas = document.getElementById('gameCanvas'); 
        ctx = canvas.getContext('2d');
        
        resize();
        window.onresize = resize;

        canvas.onmousedown = e => {
            if(placingToken){ placeTokenClick(e); return; }

            // Converter mouse para coordenadas do mundo
            const worldX = (e.clientX - view.x) / view.zoom;
            const worldY = (e.clientY - view.y) / view.zoom;

            let hitToken = null;
            // Checar colis√£o com tokens (inverso para pegar o do topo)
            const tokenKeys = Object.keys(tokens);
            for(let i = tokenKeys.length - 1; i >= 0; i--) {
                const id = tokenKeys[i];
                const t = tokens[id];
                const r = (t.size || 50) / 2;
                if(Math.sqrt((worldX - t.x)**2 + (worldY - t.y)**2) <= r) {
                    hitToken = id;
                    break;
                }
            }

            if(hitToken) {
                isTokenDrag = true;
                dragTokenId = hitToken;
            } else {
                isMapDrag = true;
            }
            lastPos = {x: e.clientX, y: e.clientY};
        };

        canvas.onmousemove = e => {
            if(!isMapDrag && !isTokenDrag) return;

            const dx = e.clientX - lastPos.x;
            const dy = e.clientY - lastPos.y;
            lastPos = {x: e.clientX, y: e.clientY};

            if(isMapDrag) {
                view.x += dx;
                view.y += dy;
                renderMap();
            } else if(isTokenDrag && dragTokenId) {
                tokens[dragTokenId].x += dx / view.zoom;
                tokens[dragTokenId].y += dy / view.zoom;
                renderMap();
            }
        };

        canvas.onmouseup = () => {
            if(isTokenDrag && dragTokenId) {
                // Salvar nova posi√ß√£o no Firebase
                saveTokens();
            }
            isMapDrag = false;
            isTokenDrag = false;
            dragTokenId = null;
        };

        // Zoom no scroll
        canvas.onwheel = e => {
            e.preventDefault();
            const scaleAmount = -e.deltaY * 0.001;
            zoomMap(scaleAmount);
        };
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        renderMap();
    }

    function renderMap() {
        if(!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.save();
        ctx.translate(view.x, view.y);
        ctx.scale(view.zoom, view.zoom);

        // Desenhar Mapa
        if(mapImg) {
            ctx.drawImage(mapImg, 0, 0);
        } else {
            // Placeholder se n√£o tiver mapa
            ctx.fillStyle = "#111";
            ctx.fillRect(0,0, 2000, 1500);
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 5;
            ctx.strokeRect(0,0, 2000, 1500);
        }

        // Desenhar Tokens
        for(let id in tokens) {
            const t = tokens[id];
            const size = t.size || 50;
            const r = size / 2;

            ctx.save();
            ctx.beginPath();
            ctx.arc(t.x, t.y, r, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();

            if(t.img) {
                const img = new Image();
                img.src = t.img;
                ctx.drawImage(img, t.x - r, t.y - r, size, size);
            } else {
                ctx.fillStyle = "var(--gold)";
                ctx.fill();
                ctx.fillStyle = "black";
                ctx.font = "bold 20px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(t.name ? t.name[0].toUpperCase() : "?", t.x, t.y);
            }
            ctx.restore();

            // Borda do Token
            ctx.beginPath();
            ctx.arc(t.x, t.y, r, 0, Math.PI * 2);
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();

            // DESENHAR NOME ACIMA DO TOKEN
            ctx.save();
            ctx.fillStyle = "white";
            ctx.font = "bold 14px Roboto";
            ctx.textAlign = "center";
            ctx.shadowColor = "black";
            ctx.shadowBlur = 4;
            ctx.lineWidth = 3;
            ctx.strokeStyle = "black";
            
            // Posi√ß√£o do texto (acima do token)
            const textY = t.y - r - 10;
            
            // Tra√ßo preto (outline) para legibilidade
            ctx.strokeText(t.name || "NPC", t.x, textY);
            // Texto branco preenchido
            ctx.fillText(t.name || "NPC", t.x, textY);
            ctx.restore();
        }

        ctx.restore();
    }

    // --- FUN√á√ïES DE CONTROLE (ZOOM, GM, AUDIO) ---
    window.zoomMap = (amount) => {
        view.zoom = Math.max(0.1, Math.min(5, view.zoom + amount));
        renderMap();
    };

    window.resetView = () => {
        view = {x: 0, y: 0, zoom: 1};
        renderMap();
    };

    window.toggleMute = () => {
        audio.muted = !audio.muted;
        document.getElementById('mute-icon').innerText = audio.muted ? "üîá" : "üîä";
    };
    window.setVolume = (v) => audio.volume = v;

    window.toggleGM = () => {
        const p = document.getElementById('gm-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    };

    window.syncWorld = async () => {
        const mapUrl = document.getElementById('gm-map').value;
        const musicUrl = document.getElementById('gm-music').value;
        const missionText = document.getElementById('gm-mission-input').value;

        await setDoc(doc(db, "campaign_settings", "global"), {
            mapa_url: mapUrl,
            musica_url: musicUrl,
            missao_atual: missionText, // Salva a miss√£o
            posicoes: tokens // Preserva tokens atuais
        }, { merge: true });
        alert("Mundo Sincronizado!");
    };

    window.activateTokenPlacement = () => {
        document.body.style.cursor = "crosshair";
        placingToken = true;
        toggleGM(); // Fecha painel
    };

    function placeTokenClick(e) {
        const worldX = (e.clientX - view.x) / view.zoom;
        const worldY = (e.clientY - view.y) / view.zoom;
        const name = document.getElementById('tk-name').value || "NPC";
        const img = document.getElementById('tk-img').value || "";
        
        const newId = "token_" + Date.now();
        tokens[newId] = { x: worldX, y: worldY, size: 60, name: name, img: img };
        
        saveTokens();
        placingToken = false;
        document.body.style.cursor = "default";
        renderMap();
    }

    async function saveTokens() {
        await updateDoc(doc(db, "campaign_settings", "global"), { posicoes: tokens });
    }

</script>
</body>
</html>
